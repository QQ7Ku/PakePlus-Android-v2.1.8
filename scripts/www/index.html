<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#3b82f6">
    <meta name="description" content="è½¦æ˜“ CarEase - ä¸œç›ŸäºŒæ‰‹è½¦å¸‚åœºåˆ†æç³»ç»Ÿï¼Œæ”¯æŒ10å›½è´§å¸è½¬æ¢ã€å¸‚åœºåˆ†æã€è½¦è¾†è¯„ä¼°">
    <title>è½¦æ˜“ CarEase - ä¸œç›ŸäºŒæ‰‹è½¦å¸‚åœºåˆ†æ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        dark: '#1e293b',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', '-apple-system', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * {
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            min-height: 100vh;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 4px 20px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .nav-item {
            transition: all 0.2s ease;
        }
        
        .nav-item.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            box-shadow: 0 4px 14px rgba(59, 130, 246, 0.4);
        }
        
        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .country-card {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .country-card:hover {
            border-color: #3b82f6;
            background: #f8fafc;
        }
        
        .country-card.selected {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
        }
        
        .stat-card {
            background: linear-gradient(135deg, #fff 0%, #f8fafc 100%);
            border-left: 4px solid #3b82f6;
        }
        
        .stat-card.success { border-left-color: #10b981; }
        .stat-card.warning { border-left-color: #f59e0b; }
        .stat-card.danger { border-left-color: #ef4444; }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            transition: all 0.2s ease;
        }
        
        .btn-primary:hover {
            box-shadow: 0 4px 14px rgba(59, 130, 246, 0.4);
            transform: translateY(-1px);
        }
        
        .input-field {
            transition: all 0.2s ease;
        }
        
        .input-field:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .range-slider {
            -webkit-appearance: none;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
        }
        
        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.4);
        }
        
        .currency-badge {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #1e293b;
            color: white;
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 9999;
            opacity: 0;
            transform: translateX(100px);
            transition: all 0.3s ease;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .tab-btn {
            transition: all 0.2s ease;
        }
        
        .tab-btn.active {
            background: #3b82f6;
            color: white;
        }
        
        .vehicle-item {
            transition: all 0.2s ease;
        }
        
        .vehicle-item:hover {
            background: #f8fafc;
        }
        
        /* Brand Analysis Styles */
        .market-content {
            animation: fadeIn 0.3s ease;
        }
        
        .brand-filter-btn {
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .brand-filter-btn:hover {
            transform: translateY(-1px);
        }
        
        .brand-filter-btn.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .model-row {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .model-row:hover {
            background: #f1f5f9;
        }
        
        .model-row.selected {
            background: #dbeafe;
        }
        
        .price-bar {
            height: 8px;
            border-radius: 4px;
            background: #e2e8f0;
            position: relative;
            overflow: hidden;
        }
        
        .price-bar-fill {
            height: 100%;
            border-radius: 4px;
            background: linear-gradient(90deg, #3b82f6 0%, #10b981 100%);
        }
        
        .trend-up {
            color: #10b981;
        }
        
        .trend-down {
            color: #ef4444;
        }
        
        .trend-flat {
            color: #94a3b8;
        }
        
        .compare-checkbox {
            width: 18px;
            height: 18px;
            border-radius: 4px;
            border: 2px solid #cbd5e1;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .compare-checkbox:checked {
            background: #3b82f6;
            border-color: #3b82f6;
        }
        
        /* Mobile Responsive Styles (ç§»åŠ¨ç«¯å“åº”å¼æ ·å¼) */
        
        /* å¹³æ¿é€‚é… (768px - 1024px) */
        @media (max-width: 1024px) {
            .chart-container {
                height: 250px;
            }
            
            .card {
                border-radius: 12px;
            }
        }
        
        /* æ‰‹æœºé€‚é… (å°äº 768px) */
        @media (max-width: 768px) {
            /* å¤´éƒ¨ä¼˜åŒ– */
            header {
                padding: 0.5rem 0;
            }
            
            header h1 {
                font-size: 16px !important;
            }
            
            header .subtitle {
                font-size: 10px !important;
            }
            
            /* ç»Ÿè®¡å¡ç‰‡è°ƒæ•´ä¸º2åˆ— */
            .grid.grid-cols-2.md\\:grid-cols-4 {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
            
            .stat-card p.text-xl {
                font-size: 16px;
            }
            
            /* å¯¼èˆªæ ‡ç­¾ä¼˜åŒ– */
            .nav-item {
                padding: 0.5rem 0.75rem;
                font-size: 12px;
            }
            
            .nav-item svg {
                width: 16px;
                height: 16px;
            }
            
            /* å›¾è¡¨é«˜åº¦è°ƒæ•´ */
            .chart-container {
                height: 200px;
            }
            
            /* å¡ç‰‡å†…è¾¹è·è°ƒæ•´ */
            .card.p-5 {
                padding: 1rem;
            }
            
            /* è¡¨æ ¼æ¨ªå‘æ»šåŠ¨ */
            .overflow-x-auto {
                -webkit-overflow-scrolling: touch;
            }
            
            table {
                min-width: 600px;
            }
            
            /* åº•éƒ¨å®‰å…¨åŒºåŸŸ */
            main {
                padding-bottom: 100px !important;
            }
            
            /* æ‚¬æµ®æŒ‰é’®ä½ç½®è°ƒæ•´ */
            #calcToggleBtn {
                bottom: 80px;
                right: 16px;
                width: 48px;
                height: 48px;
            }
            
            /* è®¡ç®—å™¨çª—å£å…¨å± */
            #calcWidget {
                width: calc(100vw - 32px) !important;
                left: 16px !important;
                right: 16px !important;
                bottom: 80px !important;
            }
            
            /* å›½å®¶é€‰æ‹©å™¨å…¨å± */
            #countryModal > div {
                max-width: 100%;
                border-radius: 1rem 1rem 0 0;
                max-height: 70vh;
            }
            
            /* è¾“å…¥æ¡†ä¼˜åŒ– */
            input, select {
                font-size: 16px !important; /* é˜²æ­¢iOSç¼©æ”¾ */
                padding: 0.625rem 0.75rem;
            }
            
            /* è§¦æ‘¸ä¼˜åŒ– */
            .btn, .nav-item, .brand-filter-btn {
                min-height: 44px; /* iOSæ¨èè§¦æ‘¸ç›®æ ‡å¤§å° */
            }
            
            /* å“ç‰Œç­›é€‰æ¨ªå‘æ»šåŠ¨ */
            #brandFilterList {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 0.5rem;
            }
        }
        
        /* å°å±æ‰‹æœº (å°äº 480px) */
        @media (max-width: 480px) {
            .chart-container {
                height: 180px;
            }
            
            .nav-item span {
                display: none; /* éšè—å¯¼èˆªæ–‡å­— */
            }
            
            .nav-item {
                padding: 0.5rem;
            }
            
            .grid.md\\:grid-cols-2, 
            .grid.md\\:grid-cols-3 {
                grid-template-columns: 1fr;
            }
            
            /* KPIå¡ç‰‡å…¨å®½ */
            #queryResults .grid.grid-cols-2.md\\:grid-cols-4 > div {
                grid-column: span 2;
            }
        }
        
        /* åº•éƒ¨å¯¼èˆªæ  (ç§»åŠ¨ç«¯ä¸“ç”¨) */
        .mobile-nav {
            display: none;
        }
        
        @media (max-width: 768px) {
            .mobile-nav {
                display: flex;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: rgba(255, 255, 255, 0.95);
                backdrop-filter: blur(10px);
                border-top: 1px solid rgba(0,0,0,0.1);
                padding: 0.5rem 0 calc(0.5rem + env(safe-area-inset-bottom));
                z-index: 100;
                justify-content: space-around;
            }
            
            .mobile-nav-item {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                padding: 0.25rem;
                color: #64748b;
                font-size: 10px;
                transition: all 0.2s;
                min-height: 50px;
            }
            
            .mobile-nav-item.active {
                color: #3b82f6;
            }
            
            .mobile-nav-item svg {
                width: 24px;
                height: 24px;
                margin-bottom: 2px;
            }
            
            /* æ¡Œé¢ç«¯å¯¼èˆªéšè— */
            .desktop-nav {
                display: none;
            }
        }
        
        /* è§¦æ‘¸è®¾å¤‡ä¼˜åŒ– */
        @media (hover: none) and (pointer: coarse) {
            .card:hover {
                transform: none;
            }
            
            .vehicle-item:hover,
            .model-row:hover {
                background: transparent;
            }
            
            .vehicle-item:active,
            .model-row:active {
                background: #f1f5f9;
            }
        }
        
        /* æ¨ªå±æ¨¡å¼ä¼˜åŒ– */
        @media (max-height: 500px) and (orientation: landscape) {
            header {
                position: relative;
            }
            
            main {
                padding-top: 1rem;
            }
            
            .mobile-nav {
                display: none;
            }
        }
        
        /* PowerBI Style Query Section */
        .time-range-btn {
            transition: all 0.2s ease;
        }
        
        .time-range-btn.active {
            background: #3b82f6 !important;
            color: white !important;
        }
        
        .dealer-row {
            transition: all 0.2s ease;
        }
        
        .dealer-row:hover {
            background: #f8fafc;
        }
        
        .condition-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .condition-excellent {
            background: #dcfce7;
            color: #166534;
        }
        
        .condition-good {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .condition-fair {
            background: #fef3c7;
            color: #92400e;
        }
        
        .kpi-card {
            position: relative;
            overflow: hidden;
        }
        
        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--kpi-color) 0%, transparent 100%);
        }
    </style>
</head>
<body class="text-slate-800">
    <!-- Header -->
    <header class="glass fixed top-0 left-0 right-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
            <div>
                <h1 class="font-bold text-lg leading-tight">è½¦æ˜“ CarEase</h1>
                <p class="text-xs text-slate-500">ä¸œç›ŸäºŒæ‰‹è½¦å¸‚åœºåˆ†æ</p>
            </div>
            
            <div class="flex items-center gap-3">
                <!-- Country Selector -->
                <button onclick="openCountryModal()" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 transition-colors">
                    <span id="currentFlag" class="text-xl">ğŸ‡¸ğŸ‡¬</span>
                    <span id="currentCountry" class="text-sm font-medium">æ–°åŠ å¡</span>
                    <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400"></i>
                </button>
                
                <!-- Currency Display -->
                <div class="currency-badge" id="currencyBadge">SGD</div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="pt-20 pb-24 px-4 max-w-7xl mx-auto">
        
        <!-- Dashboard Stats -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="card stat-card p-4">
                <p class="text-xs text-slate-500 mb-1">å¸‚åœºè§„æ¨¡</p>
                <p class="text-xl font-bold text-slate-800" id="marketSize">Â¥2.8B</p>
                <p class="text-xs text-green-500 flex items-center gap-1 mt-1">
                    <i data-lucide="trending-up" class="w-3 h-3"></i> +12.5%
                </p>
            </div>
            <div class="card stat-card success p-4">
                <p class="text-xs text-slate-500 mb-1">æœˆå‡äº¤æ˜“é‡</p>
                <p class="text-xl font-bold text-slate-800" id="monthlyVolume">15,280</p>
                <p class="text-xs text-green-500 flex items-center gap-1 mt-1">
                    <i data-lucide="trending-up" class="w-3 h-3"></i> +8.3%
                </p>
            </div>
            <div class="card stat-card warning p-4">
                <p class="text-xs text-slate-500 mb-1">å¹³å‡è½¦é¾„</p>
                <p class="text-xl font-bold text-slate-800">5.2å¹´</p>
                <p class="text-xs text-slate-400 mt-1">åŒæ¯”æŒå¹³</p>
            </div>
            <div class="card stat-card danger p-4">
                <p class="text-xs text-slate-500 mb-1">æ±‡ç‡ (CNY)</p>
                <p class="text-xl font-bold text-slate-800" id="exchangeRate">5.35</p>
                <p class="text-xs text-red-500 flex items-center gap-1 mt-1">
                    <i data-lucide="trending-down" class="w-3 h-3"></i> -1.2%
                </p>
            </div>
        </div>

        <!-- Desktop Navigation Tabs (æ¡Œé¢ç«¯å¯¼èˆª) -->
        <div class="desktop-nav flex gap-2 mb-6 overflow-x-auto pb-2">
            <button class="nav-item active px-5 py-2.5 rounded-xl font-medium text-sm whitespace-nowrap flex items-center gap-2" onclick="switchTab('market')">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" x2="12" y1="20" y2="10"></line><line x1="18" x2="18" y1="20" y2="4"></line><line x1="6" x2="6" y1="20" y2="16"></line></svg>
                å¸‚åœºåˆ†æ
            </button>
            <button class="nav-item px-5 py-2.5 rounded-xl font-medium text-sm whitespace-nowrap flex items-center gap-2 bg-white text-slate-600" onclick="switchTab('query')">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg>
                è½¦å‹æŸ¥è¯¢
            </button>
            <button class="nav-item px-5 py-2.5 rounded-xl font-medium text-sm whitespace-nowrap flex items-center gap-2 bg-white text-slate-600" onclick="switchTab('vehicle')">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M12 18v-6"></path><path d="M9 15l3 3 3-3"></path></svg>
                å•è½¦åˆ†æ
            </button>
            <button class="nav-item px-5 py-2.5 rounded-xl font-medium text-sm whitespace-nowrap flex items-center gap-2 bg-white text-slate-600" onclick="switchTab('database')">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M3 5V19A9 3 0 0 0 21 19V5"></path><path d="M3 12A9 3 0 0 0 21 12"></path></svg>
                æ•°æ®åº“
            </button>
        </div>

        <!-- Market Analysis Section -->
        <div id="section-market" class="section active space-y-6">
            <!-- Market Sub-tabs -->
            <div class="flex gap-2 mb-4">
                <button class="tab-btn active px-4 py-2 rounded-lg text-sm font-medium bg-slate-100" onclick="switchMarketTab('overview')" id="tab-overview">
                    å¸‚åœºæ¦‚è§ˆ
                </button>
                <button class="tab-btn px-4 py-2 rounded-lg text-sm font-medium bg-slate-100" onclick="switchMarketTab('brand-analysis')" id="tab-brand-analysis">
                    å“ç‰Œè½¦å‹ä»·æ ¼åˆ†æ
                </button>
            </div>
            
            <!-- Overview Content -->
            <div id="market-overview" class="market-content space-y-6">
            <!-- Charts Row 1 -->
            <div class="grid md:grid-cols-2 gap-6">
                <div class="card p-5">
                    <h3 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
                        <i data-lucide="trending-up" class="w-5 h-5 text-blue-500"></i>
                        ä»·æ ¼è¶‹åŠ¿ (è¿‘12ä¸ªæœˆ)
                    </h3>
                    <div class="chart-container">
                        <canvas id="priceTrendChart"></canvas>
                    </div>
                </div>
                <div class="card p-5">
                    <h3 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
                        <i data-lucide="pie-chart" class="w-5 h-5 text-green-500"></i>
                        å“ç‰Œå¸‚åœºä»½é¢
                    </h3>
                    <div class="chart-container">
                        <canvas id="brandShareChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Charts Row 2 -->
            <div class="grid md:grid-cols-2 gap-6">
                <div class="card p-5">
                    <h3 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
                        <i data-lucide="clock" class="w-5 h-5 text-orange-500"></i>
                        è½¦é¾„åˆ†å¸ƒ
                    </h3>
                    <div class="chart-container">
                        <canvas id="ageDistChart"></canvas>
                    </div>
                </div>
                <div class="card p-5">
                    <h3 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
                        <i data-lucide="dollar-sign" class="w-5 h-5 text-purple-500"></i>
                        ä»·æ ¼åŒºé—´åˆ†å¸ƒ
                    </h3>
                    <div class="chart-container">
                        <canvas id="priceRangeChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Top Models Table -->
            <div class="card p-5">
                <h3 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
                    <i data-lucide="award" class="w-5 h-5 text-yellow-500"></i>
                    çƒ­é—¨è½¦å‹æ’è¡Œ
                </h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="text-left text-xs text-slate-500 border-b border-slate-100">
                                <th class="pb-3 font-medium">æ’å</th>
                                <th class="pb-3 font-medium">è½¦å‹</th>
                                <th class="pb-3 font-medium">å“ç‰Œ</th>
                                <th class="pb-3 font-medium text-right">å‡ä»·</th>
                                <th class="pb-3 font-medium text-right">äº¤æ˜“é‡</th>
                                <th class="pb-3 font-medium text-right">ä¿å€¼ç‡</th>
                            </tr>
                        </thead>
                        <tbody id="topModelsTable" class="text-sm">
                            <!-- Dynamic content -->
                        </tbody>
                    </table>
                </div>
            </div>
            </div><!-- End of market-overview -->
            
            <!-- Brand Analysis Content -->
            <div id="market-brand-analysis" class="market-content hidden space-y-6">
                <!-- Brand Filter -->
                <div class="card p-4">
                    <h3 class="font-semibold text-slate-800 mb-3 flex items-center gap-2">
                        <i data-lucide="filter" class="w-5 h-5 text-blue-500"></i>
                        å“ç‰Œç­›é€‰
                    </h3>
                    <div class="flex gap-2 overflow-x-auto pb-2" id="brandFilterList">
                        <!-- Brand filter buttons -->
                    </div>
                </div>
                
                <!-- Brand Summary Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="brandSummaryStats">
                    <!-- Dynamic stats -->
                </div>
                
                <!-- Price Chart for Selected Brand -->
                <div class="card p-5">
                    <h3 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
                        <i data-lucide="line-chart" class="w-5 h-5 text-green-500"></i>
                        <span id="brandChartTitle">ä¸°ç”° - è½¦å‹ä»·æ ¼åˆ†å¸ƒ</span>
                    </h3>
                    <div class="chart-container">
                        <canvas id="brandPriceChart"></canvas>
                    </div>
                </div>
                
                <!-- Model Price Analysis Table -->
                <div class="card p-5">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                            <i data-lucide="list" class="w-5 h-5 text-purple-500"></i>
                            <span id="brandTableTitle">ä¸°ç”°è½¦å‹ä»·æ ¼åˆ†æ</span>
                        </h3>
                        <div class="flex gap-2">
                            <select id="sortBy" onchange="sortModelTable()" class="px-3 py-1.5 rounded-lg border border-slate-200 text-sm">
                                <option value="price-desc">ä»·æ ¼ä»é«˜åˆ°ä½</option>
                                <option value="price-asc">ä»·æ ¼ä»ä½åˆ°é«˜</option>
                                <option value="volume">é”€é‡ä¼˜å…ˆ</option>
                                <option value="retention">ä¿å€¼ç‡ä¼˜å…ˆ</option>
                            </select>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="text-left text-xs text-slate-500 border-b border-slate-100">
                                    <th class="pb-3 font-medium">è½¦å‹</th>
                                    <th class="pb-3 font-medium text-right">å‡ä»·</th>
                                    <th class="pb-3 font-medium text-right">æœ€ä½ä»·</th>
                                    <th class="pb-3 font-medium text-right">æœ€é«˜ä»·</th>
                                    <th class="pb-3 font-medium text-right">æœˆé”€é‡</th>
                                    <th class="pb-3 font-medium text-right">ä¿å€¼ç‡</th>
                                    <th class="pb-3 font-medium text-right">ä»·æ ¼è¶‹åŠ¿</th>
                                </tr>
                            </thead>
                            <tbody id="brandModelTable" class="text-sm">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Model Comparison Section -->
                <div class="card p-5" id="comparisonSection" style="display: none;">
                    <h3 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
                        <i data-lucide="git-compare" class="w-5 h-5 text-orange-500"></i>
                        è½¦å‹å¯¹æ¯”åˆ†æ
                    </h3>
                    <div class="chart-container mb-4">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                    <div id="comparisonDetails" class="grid md:grid-cols-2 gap-4">
                        <!-- Dynamic comparison details -->
                    </div>
                </div>
            </div><!-- End of market-brand-analysis -->
        </div>

        <!-- Car Model Query Section (PowerBI Style) -->
        <div id="section-query" class="section space-y-6">
            <!-- Search Header -->
            <div class="card p-5">
                <h3 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
                    <i data-lucide="search" class="w-5 h-5 text-blue-500"></i>
                    è½¦å‹ä»·æ ¼æŸ¥è¯¢
                </h3>
                <div class="flex gap-3">
                    <div class="flex-1 relative">
                        <i data-lucide="search" class="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                        <input type="text" id="carSearchInput" 
                               class="input-field w-full pl-10 pr-4 py-3 rounded-xl border border-slate-200 text-base"
                               placeholder="æœç´¢è½¦å‹ï¼Œå¦‚ï¼šè¿ˆè…¾ 2023ã€å‡¯ç¾ç‘ 2022ã€å®é©¬3ç³»..."
                               onkeypress="if(event.key==='Enter') searchCarModel()">
                    </div>
                    <button onclick="searchCarModel()" class="btn-primary px-6 py-3 rounded-xl text-white font-semibold flex items-center gap-2">
                        <i data-lucide="search" class="w-5 h-5"></i>
                        æŸ¥è¯¢
                    </button>
                </div>
                <div class="flex gap-2 mt-3 flex-wrap">
                    <span class="text-xs text-slate-400">çƒ­é—¨æœç´¢ï¼š</span>
                    <button onclick="quickSearch('è¿ˆè…¾ 2023')" class="text-xs px-3 py-1 bg-slate-100 hover:bg-slate-200 rounded-full transition-colors">è¿ˆè…¾ 2023</button>
                    <button onclick="quickSearch('å‡¯ç¾ç‘ 2022')" class="text-xs px-3 py-1 bg-slate-100 hover:bg-slate-200 rounded-full transition-colors">å‡¯ç¾ç‘ 2022</button>
                    <button onclick="quickSearch('å®é©¬3ç³» 2023')" class="text-xs px-3 py-1 bg-slate-100 hover:bg-slate-200 rounded-full transition-colors">å®é©¬3ç³» 2023</button>
                    <button onclick="quickSearch('å¡ç½—æ‹‰ 2021')" class="text-xs px-3 py-1 bg-slate-100 hover:bg-slate-200 rounded-full transition-colors">å¡ç½—æ‹‰ 2021</button>
                    <button onclick="quickSearch('CR-V 2022')" class="text-xs px-3 py-1 bg-slate-100 hover:bg-slate-200 rounded-full transition-colors">CR-V 2022</button>
                </div>
            </div>
            
            <!-- Search Results & PowerBI Dashboard -->
            <div id="queryResults" class="hidden space-y-6">
                <!-- Car Header Info -->
                <div class="card p-5 bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-100">
                    <div class="flex items-start justify-between">
                        <div>
                            <div class="flex items-center gap-3 mb-2">
                                <h2 class="text-2xl font-bold text-slate-800" id="queryCarName">å¤§ä¼— è¿ˆè…¾ 2023æ¬¾</h2>
                                <span class="px-3 py-1 bg-blue-500 text-white text-sm rounded-full" id="queryCarYear">2023æ¬¾</span>
                            </div>
                            <p class="text-slate-500" id="queryCarSubtitle">ä¸­å‹è½¿è½¦ | 2.0T åŒç¦»åˆ | å‰ç½®å‰é©±</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-slate-500">å¸‚åœºæŒ‡å¯¼ä»·</p>
                            <p class="text-3xl font-bold text-blue-600" id="queryCarPrice">Â¥189,900</p>
                        </div>
                    </div>
                </div>
                
                <!-- PowerBI Style KPI Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="card p-4 border-l-4 border-blue-500">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs text-slate-500">äºŒæ‰‹è½¦å‡ä»·</span>
                            <i data-lucide="dollar-sign" class="w-4 h-4 text-blue-500"></i>
                        </div>
                        <p class="text-2xl font-bold text-slate-800" id="kpiAvgPrice">Â¥158,000</p>
                        <p class="text-xs text-green-500 mt-1 flex items-center gap-1">
                            <i data-lucide="trending-up" class="w-3 h-3"></i> è¾ƒä¸Šæœˆ +2.3%
                        </p>
                    </div>
                    <div class="card p-4 border-l-4 border-green-500">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs text-slate-500">ä»·æ ¼åŒºé—´</span>
                            <i data-lucide="arrow-left-right" class="w-4 h-4 text-green-500"></i>
                        </div>
                        <p class="text-lg font-bold text-slate-800" id="kpiPriceRange">Â¥142k - Â¥175k</p>
                        <p class="text-xs text-slate-400 mt-1">å…¨å›½ç»é”€å•†æŠ¥ä»·</p>
                    </div>
                    <div class="card p-4 border-l-4 border-orange-500">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs text-slate-500">ä¿å€¼ç‡</span>
                            <i data-lucide="shield-check" class="w-4 h-4 text-orange-500"></i>
                        </div>
                        <p class="text-2xl font-bold text-slate-800" id="kpiRetention">73%</p>
                        <p class="text-xs text-slate-400 mt-1">3å¹´ä¿å€¼ç‡</p>
                    </div>
                    <div class="card p-4 border-l-4 border-purple-500">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-xs text-slate-500">æœˆäº¤æ˜“é‡</span>
                            <i data-lucide="activity" class="w-4 h-4 text-purple-500"></i>
                        </div>
                        <p class="text-2xl font-bold text-slate-800" id="kpiVolume">1,258</p>
                        <p class="text-xs text-green-500 mt-1 flex items-center gap-1">
                            <i data-lucide="trending-up" class="w-3 h-3"></i> è¾ƒä¸Šæœˆ +5.8%
                        </p>
                    </div>
                </div>
                
                <!-- PowerBI Charts Row 1 -->
                <div class="grid md:grid-cols-3 gap-6">
                    <!-- Price Trend Chart -->
                    <div class="card p-5 md:col-span-2">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                                <i data-lucide="line-chart" class="w-5 h-5 text-blue-500"></i>
                                å†å²ä»·æ ¼èµ°åŠ¿
                            </h3>
                            <div class="flex gap-2">
                                <button onclick="changeTimeRange('6m')" class="time-range-btn px-3 py-1 text-xs rounded-lg bg-blue-500 text-white" data-range="6m">6ä¸ªæœˆ</button>
                                <button onclick="changeTimeRange('1y')" class="time-range-btn px-3 py-1 text-xs rounded-lg bg-slate-100" data-range="1y">1å¹´</button>
                                <button onclick="changeTimeRange('2y')" class="time-range-btn px-3 py-1 text-xs rounded-lg bg-slate-100" data-range="2y">2å¹´</button>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="queryPriceTrendChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Price Distribution Gauge -->
                    <div class="card p-5">
                        <h3 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
                            <i data-lucide="gauge" class="w-5 h-5 text-green-500"></i>
                            ä»·æ ¼å¥åº·åº¦
                        </h3>
                        <div class="chart-container" style="height: 200px;">
                            <canvas id="priceGaugeChart"></canvas>
                        </div>
                        <div class="text-center mt-3">
                            <p class="text-sm text-slate-500">å½“å‰ä»·æ ¼å¤„äº</p>
                            <p class="text-lg font-bold text-green-500">åˆç†åŒºé—´</p>
                        </div>
                    </div>
                </div>
                
                <!-- PowerBI Charts Row 2 -->
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Regional Price Comparison -->
                    <div class="card p-5">
                        <h3 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
                            <i data-lucide="map-pin" class="w-5 h-5 text-orange-500"></i>
                            åŒºåŸŸä»·æ ¼å¯¹æ¯”
                        </h3>
                        <div class="chart-container">
                            <canvas id="regionalPriceChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Competitor Comparison -->
                    <div class="card p-5">
                        <h3 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
                            <i data-lucide="users" class="w-5 h-5 text-purple-500"></i>
                            ç«å“å¯¹æ¯”
                        </h3>
                        <div class="chart-container">
                            <canvas id="competitorChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- PowerBI Charts Row 3 -->
                <div class="grid md:grid-cols-3 gap-6">
                    <!-- Age vs Price Scatter -->
                    <div class="card p-5">
                        <h3 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
                            <i data-lucide="scatter-chart" class="w-5 h-5 text-blue-500"></i>
                            é‡Œç¨‹-ä»·æ ¼åˆ†å¸ƒ
                        </h3>
                        <div class="chart-container">
                            <canvas id="mileagePriceChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Depreciation Forecast -->
                    <div class="card p-5 md:col-span-2">
                        <h3 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
                            <i data-lucide="trending-down" class="w-5 h-5 text-red-500"></i>
                            æ®‹å€¼é¢„æµ‹ (æœªæ¥5å¹´)
                        </h3>
                        <div class="chart-container">
                            <canvas id="depreciationForecastChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Dealers Table -->
                <div class="card p-5">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                            <i data-lucide="store" class="w-5 h-5 text-indigo-500"></i>
                            åœ¨å”®è½¦æº (å…¨å›½)
                        </h3>
                        <div class="flex gap-2">
                            <select id="dealerSort" onchange="sortDealerTable()" class="px-3 py-1.5 rounded-lg border border-slate-200 text-sm">
                                <option value="price-asc">ä»·æ ¼ä»ä½åˆ°é«˜</option>
                                <option value="price-desc">ä»·æ ¼ä»é«˜åˆ°ä½</option>
                                <option value="mileage">é‡Œç¨‹ä»ä½åˆ°é«˜</option>
                                <option value="newest">æœ€æ–°å‘å¸ƒ</option>
                            </select>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="text-left text-xs text-slate-500 border-b border-slate-100">
                                    <th class="pb-3 font-medium">è½¦è¾†ä¿¡æ¯</th>
                                    <th class="pb-3 font-medium text-right">ä»·æ ¼</th>
                                    <th class="pb-3 font-medium text-right">é‡Œç¨‹</th>
                                    <th class="pb-3 font-medium text-right">è½¦é¾„</th>
                                    <th class="pb-3 font-medium">æ‰€åœ¨åœ°</th>
                                    <th class="pb-3 font-medium">è½¦å†µè¯„çº§</th>
                                    <th class="pb-3 font-medium text-right">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="dealerTable" class="text-sm">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Empty State -->
            <div id="queryEmptyState" class="card p-12 text-center">
                <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-slate-100 flex items-center justify-center">
                    <i data-lucide="search" class="w-10 h-10 text-slate-400"></i>
                </div>
                <h3 class="text-lg font-semibold text-slate-700 mb-2">æœç´¢è½¦å‹æŸ¥çœ‹ä»·æ ¼åˆ†æ</h3>
                <p class="text-slate-500 mb-4">è¾“å…¥å“ç‰Œå’Œè½¦å‹å¹´ä»½ï¼Œè·å–è¯¦ç»†çš„å¸‚åœºä»·æ ¼æŠ¥å‘Š</p>
                <div class="flex gap-2 justify-center flex-wrap">
                    <button onclick="quickSearch('è¿ˆè…¾ 2023')" class="px-4 py-2 bg-blue-50 text-blue-600 rounded-lg text-sm font-medium hover:bg-blue-100 transition-colors">
                        è¯•è¯•æœç´¢ "è¿ˆè…¾ 2023"
                    </button>
                </div>
            </div>
        </div>

        <!-- Vehicle Analysis Section -->
        <div id="section-vehicle" class="section space-y-6">
            <!-- Vehicle Input Form -->
            <div class="card p-5">
                <h3 class="font-semibold text-slate-800 mb-4 flex items-center gap-2">
                    <i data-lucide="file-input" class="w-5 h-5 text-blue-500"></i>
                    è½¦è¾†ä¿¡æ¯å½•å…¥
                </h3>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-2">å“ç‰Œ</label>
                        <select id="vBrand" class="input-field w-full px-4 py-2.5 rounded-xl border border-slate-200 bg-white">
                            <option value="">é€‰æ‹©å“ç‰Œ</option>
                            <option value="toyota">ä¸°ç”° Toyota</option>
                            <option value="honda">æœ¬ç”° Honda</option>
                            <option value="nissan">æ—¥äº§ Nissan</option>
                            <option value="mazda">é©¬è‡ªè¾¾ Mazda</option>
                            <option value="mitsubishi">ä¸‰è± Mitsubishi</option>
                            <option value="bmw">å®é©¬ BMW</option>
                            <option value="mercedes">å¥”é©° Mercedes</option>
                            <option value="audi">å¥¥è¿ª Audi</option>
                            <option value="hyundai">ç°ä»£ Hyundai</option>
                            <option value="kia">èµ·äºš Kia</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-2">è½¦å‹</label>
                        <input type="text" id="vModel" class="input-field w-full px-4 py-2.5 rounded-xl border border-slate-200" placeholder="å¦‚ï¼šCamry 2.5">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-2">å¹´ä»½</label>
                        <select id="vYear" class="input-field w-full px-4 py-2.5 rounded-xl border border-slate-200 bg-white">
                            <!-- Dynamic years -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-2">è¡Œé©¶é‡Œç¨‹ (km)</label>
                        <input type="number" id="vMileage" class="input-field w-full px-4 py-2.5 rounded-xl border border-slate-200" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-2">æ–°è½¦ä»·æ ¼ (<span class="currency-label"></span>)</label>
                        <input type="number" id="vNewPrice" class="input-field w-full px-4 py-2.5 rounded-xl border border-slate-200" placeholder="0">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-600 mb-2">å½“å‰æŠ¥ä»· (<span class="currency-label"></span>)</label>
                        <input type="number" id="vPrice" class="input-field w-full px-4 py-2.5 rounded-xl border border-slate-200" placeholder="0">
                    </div>
                </div>
                <button onclick="analyzeVehicle()" class="btn-primary w-full mt-5 py-3 rounded-xl text-white font-semibold">
                    å¼€å§‹åˆ†æ
                </button>
            </div>
            
            <!-- Analysis Results -->
            <div id="vehicleResults" class="hidden space-y-6">
                <!-- Score Card -->
                <div class="card p-5">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                            <i data-lucide="activity" class="w-5 h-5 text-green-500"></i>
                            ç»¼åˆè¯„åˆ†
                        </h3>
                        <span class="text-3xl font-bold text-blue-500" id="totalScore">85</span>
                    </div>
                    <div class="w-full bg-slate-100 rounded-full h-3 mb-4">
                        <div id="scoreBar" class="bg-gradient-to-r from-blue-500 to-green-500 h-3 rounded-full transition-all duration-1000" style="width: 85%"></div>
                    </div>
                    <div class="grid grid-cols-4 gap-4 text-center">
                        <div class="p-3 bg-slate-50 rounded-xl">
                            <p class="text-xs text-slate-500">æ€§ä»·æ¯”</p>
                            <p class="text-lg font-bold text-green-500" id="scoreValue">90</p>
                        </div>
                        <div class="p-3 bg-slate-50 rounded-xl">
                            <p class="text-xs text-slate-500">è½¦å†µ</p>
                            <p class="text-lg font-bold text-blue-500" id="scoreCondition">82</p>
                        </div>
                        <div class="p-3 bg-slate-50 rounded-xl">
                            <p class="text-xs text-slate-500">ä¿å€¼ç‡</p>
                            <p class="text-lg font-bold text-orange-500" id="scoreRetention">78</p>
                        </div>
                        <div class="p-3 bg-slate-50 rounded-xl">
                            <p class="text-xs text-slate-500">å¸‚åœºéœ€æ±‚</p>
                            <p class="text-lg font-bold text-purple-500" id="scoreDemand">88</p>
                        </div>
                    </div>
                </div>
                
                <!-- Charts -->
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="card p-5">
                        <h3 class="font-semibold text-slate-800 mb-4">è½¦è¾†è¯„ä¼°ç»´åº¦</h3>
                        <div class="chart-container">
                            <canvas id="vehicleRadarChart"></canvas>
                        </div>
                    </div>
                    <div class="card p-5">
                        <h3 class="font-semibold text-slate-800 mb-4">æ®‹å€¼é¢„æµ‹</h3>
                        <div class="chart-container">
                            <canvas id="depreciationChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Recommendation -->
                <div class="card p-5" id="recommendationCard">
                    <h3 class="font-semibold text-slate-800 mb-3 flex items-center gap-2">
                        <i data-lucide="lightbulb" class="w-5 h-5 text-yellow-500"></i>
                        è¯„ä¼°å»ºè®®
                    </h3>
                    <div id="recommendationText" class="text-slate-600 leading-relaxed">
                        <!-- Dynamic content -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Database Section -->
        <div id="section-database" class="section space-y-6">
            <div class="card p-5">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-semibold text-slate-800 flex items-center gap-2">
                        <i data-lucide="archive" class="w-5 h-5 text-purple-500"></i>
                        å·²ä¿å­˜çš„è½¦è¾†è®°å½•
                    </h3>
                    <button onclick="exportDatabase()" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-sm font-medium transition-colors">
                        å¯¼å‡ºæ•°æ®
                    </button>
                </div>
                <div id="savedVehiclesList" class="space-y-3">
                    <!-- Dynamic content -->
                </div>
                <div id="emptyState" class="text-center py-12 text-slate-400">
                    <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                    <p>æš‚æ— ä¿å­˜çš„è®°å½•</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Mobile Bottom Navigation (ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆª) -->
    <nav class="mobile-nav">
        <button class="mobile-nav-item active" onclick="switchMobileTab('market')" data-tab="market">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" x2="12" y1="20" y2="10"></line><line x1="18" x2="18" y1="20" y2="4"></line><line x1="6" x2="6" y1="20" y2="16"></line></svg>
            å¸‚åœº
        </button>
        <button class="mobile-nav-item" onclick="switchMobileTab('query')" data-tab="query">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"></path></svg>
            æŸ¥è¯¢
        </button>
        <button class="mobile-nav-item" onclick="switchMobileTab('vehicle')" data-tab="vehicle">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M12 18v-6"></path><path d="M9 15l3 3 3-3"></path></svg>
            åˆ†æ
        </button>
        <button class="mobile-nav-item" onclick="switchMobileTab('database')" data-tab="database">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M3 5V19A9 3 0 0 0 21 19V5"></path><path d="M3 12A9 3 0 0 0 21 12"></path></svg>
            è®°å½•
        </button>
    </nav>

    <!-- Country Selection Modal -->
    <div id="countryModal" class="fixed inset-0 bg-black/50 z-50 hidden items-end sm:items-center justify-center">
        <div class="bg-white w-full max-w-md sm:rounded-2xl rounded-t-2xl p-5 max-h-[80vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-lg">é€‰æ‹©å›½å®¶/åœ°åŒº</h3>
                <button onclick="closeCountryModal()" class="p-2 hover:bg-slate-100 rounded-lg">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="grid grid-cols-2 gap-3" id="countryList">
                <!-- Dynamic country cards -->
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();
        
        // ==========================================
        // ASEAN Countries Configuration
        // ==========================================
        // ==========================================
        // Multi-Agent System (å¤šAgenté€‚é…ç³»ç»Ÿ)
        // ==========================================
        
        // Agent é…ç½®å®šä¹‰
        const AGENT_CONFIG = {
            china: {
                name: 'ä¸­å›½Agent',
                nameEn: 'China Agent',
                features: {
                    showCNYFirst: true,           // ä¼˜å…ˆæ˜¾ç¤ºäººæ°‘å¸
                    showDomesticBrands: true,      // çªå‡ºå›½äº§å“ç‰Œ
                    showImportTax: false,          // ä¸æ˜¾ç¤ºè¿›å£ç¨ä¿¡æ¯
                    enablePlateQuery: true,        // æ”¯æŒè½¦ç‰ŒæŸ¥è¯¢
                    enableVINQuery: true,          // æ”¯æŒVINæŸ¥è¯¢
                    showLocalMarket: true,         // æ˜¾ç¤ºæœ¬åœ°å¸‚åœºæ•°æ®
                },
                dataSource: 'china-mainland',
                apiEndpoints: {
                    price: '/api/china/price',
                    market: '/api/china/market',
                    dealer: '/api/china/dealer'
                },
                ui: {
                    primaryColor: '#ef4444',       // ä¸­å›½çº¢
                    secondaryColor: '#f59e0b',     // é‡‘è‰²
                    showProvinces: true,           // æ˜¾ç¤ºçœä»½é€‰æ‹©
                    cities: ['åŒ—äº¬', 'ä¸Šæµ·', 'å¹¿å·', 'æ·±åœ³', 'æˆéƒ½', 'æ­å·', 'æ­¦æ±‰', 'è¥¿å®‰', 'é‡åº†', 'å—äº¬']
                }
            },
            asean: {
                name: 'ä¸œç›ŸAgent',
                nameEn: 'ASEAN Agent',
                features: {
                    showCNYFirst: false,           // ä¸ä¼˜å…ˆæ˜¾ç¤ºäººæ°‘å¸
                    showDomesticBrands: false,     // ä¸çªå‡ºç‰¹å®šå“ç‰Œ
                    showImportTax: true,           // æ˜¾ç¤ºè¿›å£ç¨ä¿¡æ¯
                    enablePlateQuery: false,       // ä¸æ”¯æŒè½¦ç‰ŒæŸ¥è¯¢
                    enableVINQuery: true,          // æ”¯æŒVINæŸ¥è¯¢
                    showLocalMarket: true,         // æ˜¾ç¤ºæœ¬åœ°å¸‚åœºæ•°æ®
                },
                dataSource: 'asean-regional',
                apiEndpoints: {
                    price: '/api/asean/price',
                    market: '/api/asean/market',
                    dealer: '/api/asean/dealer'
                },
                ui: {
                    primaryColor: '#3b82f6',       // è“è‰²
                    secondaryColor: '#10b981',     // ç»¿è‰²
                    showProvinces: false,          // ä¸æ˜¾ç¤ºçœä»½é€‰æ‹©
                    cities: ['Singapore', 'Kuala Lumpur', 'Bangkok', 'Jakarta', 'Ho Chi Minh', 'Manila', 'Yangon', 'Phnom Penh']
                }
            }
        };
        
        // å½“å‰Agentå®ä¾‹
        let currentAgent = null;
        
        // Agent Manager (Agentç®¡ç†å™¨)
        const AgentManager = {
            // åˆå§‹åŒ–Agent
            init(agentType) {
                const config = AGENT_CONFIG[agentType];
                if (!config) {
                    console.error(`Unknown agent type: ${agentType}`);
                    return null;
                }
                
                currentAgent = {
                    type: agentType,
                    config: config,
                    
                    // è·å–æœ¬åœ°åŒ–çš„ä»·æ ¼æ˜¾ç¤º
                    formatPrice(price, currency) {
                        if (this.config.features.showCNYFirst && currency === 'CNY') {
                            return `Â¥${price.toLocaleString('zh-CN')}`;
                        }
                        return `${currentCountry.symbol}${price.toLocaleString()}`;
                    },
                    
                    // è·å–æœ¬åœ°åŒ–çš„æ—¶é—´
                    formatTime(date) {
                        return new Intl.DateTimeFormat(currentCountry.locale, {
                            timeZone: currentCountry.timezone,
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        }).format(date);
                    },
                    
                    // è·å–å½“å‰Agentæ”¯æŒçš„åŸå¸‚åˆ—è¡¨
                    getCities() {
                        return this.config.ui.cities;
                    },
                    
                    // æ£€æŸ¥åŠŸèƒ½æ˜¯å¦å¯ç”¨
                    isFeatureEnabled(featureName) {
                        return this.config.features[featureName] || false;
                    },
                    
                    // è·å–ä¸»é¢˜è‰²
                    getThemeColor() {
                        return this.config.ui.primaryColor;
                    }
                };
                
                // åº”ç”¨Agentç‰¹å®šçš„UIä¸»é¢˜
                this.applyTheme();
                
                return currentAgent;
            },
            
            // åº”ç”¨ä¸»é¢˜
            applyTheme() {
                if (!currentAgent) return;
                
                const root = document.documentElement;
                root.style.setProperty('--agent-primary', currentAgent.config.ui.primaryColor);
                root.style.setProperty('--agent-secondary', currentAgent.config.ui.secondaryColor);
                
                // æ›´æ–°Headeré¢œè‰²
                const header = document.querySelector('header');
                if (header && currentAgent.type === 'china') {
                    header.style.background = 'linear-gradient(135deg, #fef2f2 0%, #fff1f2 100%)';
                } else if (header) {
                    header.style.background = 'rgba(255, 255, 255, 0.85)';
                }
            },
            
            // æ ¹æ®å›½å®¶ä»£ç è‡ªåŠ¨åˆ‡æ¢Agent
            switchAgentByCountry(countryCode) {
                const country = SUPPORTED_COUNTRIES.find(c => c.code === countryCode);
                if (!country) return;
                
                const newAgentType = country.agent;
                if (newAgentType !== (currentAgent?.type)) {
                    this.init(newAgentType);
                    console.log(`Switched to ${newAgentType} agent`);
                }
            },
            
            // è·å–å½“å‰Agent
            getCurrentAgent() {
                return currentAgent;
            }
        };
        
        // ==========================================
        // Multi-Agent Country Configuration (å¤šAgentå›½å®¶é…ç½®)
        // ==========================================
        const SUPPORTED_COUNTRIES = [
            // ä¸­å›½ (China) - æ–°å¢
            { 
                code: 'CN', 
                name: 'ä¸­å›½', 
                nameEn: 'China',
                currency: 'CNY', 
                symbol: 'Â¥', 
                flag: 'ğŸ‡¨ğŸ‡³', 
                rate: 1.0,
                timezone: 'Asia/Shanghai',
                locale: 'zh-CN',
                agent: 'china'
            },
            // ä¸œç›Ÿå›½å®¶ (ASEAN Countries)
            { code: 'SG', name: 'æ–°åŠ å¡', nameEn: 'Singapore', currency: 'SGD', symbol: 'S$', flag: 'ğŸ‡¸ğŸ‡¬', rate: 5.35, timezone: 'Asia/Singapore', locale: 'en-SG', agent: 'asean' },
            { code: 'MY', name: 'é©¬æ¥è¥¿äºš', nameEn: 'Malaysia', currency: 'MYR', symbol: 'RM', flag: 'ğŸ‡²ğŸ‡¾', rate: 1.52, timezone: 'Asia/Kuala_Lumpur', locale: 'ms-MY', agent: 'asean' },
            { code: 'TH', name: 'æ³°å›½', nameEn: 'Thailand', currency: 'THB', symbol: 'à¸¿', flag: 'ğŸ‡¹ğŸ‡­', rate: 0.20, timezone: 'Asia/Bangkok', locale: 'th-TH', agent: 'asean' },
            { code: 'ID', name: 'å°å°¼', nameEn: 'Indonesia', currency: 'IDR', symbol: 'Rp', flag: 'ğŸ‡®ğŸ‡©', rate: 0.00045, timezone: 'Asia/Jakarta', locale: 'id-ID', agent: 'asean' },
            { code: 'VN', name: 'è¶Šå—', nameEn: 'Vietnam', currency: 'VND', symbol: 'â‚«', flag: 'ğŸ‡»ğŸ‡³', rate: 0.00029, timezone: 'Asia/Ho_Chi_Minh', locale: 'vi-VN', agent: 'asean' },
            { code: 'PH', name: 'è²å¾‹å®¾', nameEn: 'Philippines', currency: 'PHP', symbol: 'â‚±', flag: 'ğŸ‡µğŸ‡­', rate: 0.13, timezone: 'Asia/Manila', locale: 'en-PH', agent: 'asean' },
            { code: 'MM', name: 'ç¼…ç”¸', nameEn: 'Myanmar', currency: 'MMK', symbol: 'K', flag: 'ğŸ‡²ğŸ‡²', rate: 0.0034, timezone: 'Asia/Yangon', locale: 'my-MM', agent: 'asean' },
            { code: 'KH', name: 'æŸ¬åŸ”å¯¨', nameEn: 'Cambodia', currency: 'KHR', symbol: 'áŸ›', flag: 'ğŸ‡°ğŸ‡­', rate: 0.0017, timezone: 'Asia/Phnom_Penh', locale: 'km-KH', agent: 'asean' },
            { code: 'LA', name: 'è€æŒ', nameEn: 'Laos', currency: 'LAK', symbol: 'â‚­', flag: 'ğŸ‡±ğŸ‡¦', rate: 0.00033, timezone: 'Asia/Vientiane', locale: 'lo-LA', agent: 'asean' },
            { code: 'BN', name: 'æ–‡è±', nameEn: 'Brunei', currency: 'BND', symbol: 'B$', flag: 'ğŸ‡§ğŸ‡³', rate: 5.35, timezone: 'Asia/Brunei', locale: 'ms-BN', agent: 'asean' },
        ];
        
        let currentCountry = SUPPORTED_COUNTRIES[0];
        let savedVehicles = [];
        let charts = {};
        var MARKET_CHART_BASE = {
            priceTrend: [[85000,86000,84500,87000,88000,86500,89000,90000,88500,91000,92000,91500],[92000,93000,91500,94000,95000,93500,96000,97000,95500,98000,99000,98500]]
        };
        
        // ==========================================
        // Car Model Query Database
        // ==========================================
        const CAR_MODEL_DATABASE = {
            'è¿ˆè…¾': {
                brand: 'å¤§ä¼—',
                model: 'è¿ˆè…¾',
                englishName: 'Volkswagen Magotan',
                category: 'ä¸­å‹è½¿è½¦',
                specs: '2.0T åŒç¦»åˆ | å‰ç½®å‰é©±',
                newCarPrice: 189900,
                years: {
                    '2023': { avgPrice: 158000, minPrice: 142000, maxPrice: 175000, retention: 83, volume: 1258 },
                    '2022': { avgPrice: 142000, minPrice: 128000, maxPrice: 158000, retention: 75, volume: 2156 },
                    '2021': { avgPrice: 128000, minPrice: 115000, maxPrice: 142000, retention: 67, volume: 1890 },
                    '2020': { avgPrice: 112000, minPrice: 98000, maxPrice: 128000, retention: 59, volume: 1420 }
                },
                priceHistory: {
                    '6m': [155000, 156000, 154000, 157000, 158000, 158000],
                    '1y': [162000, 160000, 158000, 156000, 155000, 154000, 155000, 156000, 157000, 158000, 158000, 158000],
                    '2y': [178000, 175000, 172000, 168000, 165000, 162000, 160000, 158000, 156000, 155000, 154000, 155000, 156000, 157000, 158000, 158000, 158000, 157000, 156000, 155000, 154000, 155000, 156000, 157000]
                },
                competitors: [
                    { name: 'å‡¯ç¾ç‘', avgPrice: 152000, retention: 78 },
                    { name: 'é›…é˜', avgPrice: 148000, retention: 76 },
                    { name: 'å¤©ç±', avgPrice: 138000, retention: 71 },
                    { name: 'å›å¨', avgPrice: 128000, retention: 68 }
                ]
            },
            'å‡¯ç¾ç‘': {
                brand: 'ä¸°ç”°',
                model: 'å‡¯ç¾ç‘',
                englishName: 'Toyota Camry',
                category: 'ä¸­å‹è½¿è½¦',
                specs: '2.5L è‡ªåŠ¨ | å‰ç½®å‰é©±',
                newCarPrice: 219800,
                years: {
                    '2023': { avgPrice: 185000, minPrice: 168000, maxPrice: 205000, retention: 84, volume: 2156 },
                    '2022': { avgPrice: 168000, minPrice: 152000, maxPrice: 188000, retention: 76, volume: 3240 },
                    '2021': { avgPrice: 152000, minPrice: 138000, maxPrice: 168000, retention: 69, volume: 2890 },
                    '2020': { avgPrice: 138000, minPrice: 122000, maxPrice: 152000, retention: 63, volume: 2120 }
                },
                priceHistory: {
                    '6m': [182000, 183000, 184000, 185000, 185000, 185000],
                    '1y': [192000, 190000, 188000, 186000, 184000, 183000, 182000, 183000, 184000, 185000, 185000, 185000],
                    '2y': [205000, 202000, 198000, 195000, 192000, 190000, 188000, 186000, 184000, 183000, 182000, 183000, 184000, 185000, 185000, 185000, 184000, 183000, 182000, 181000, 180000, 181000, 182000, 183000]
                },
                competitors: [
                    { name: 'è¿ˆè…¾', avgPrice: 158000, retention: 83 },
                    { name: 'é›…é˜', avgPrice: 148000, retention: 76 },
                    { name: 'å¤©ç±', avgPrice: 138000, retention: 71 },
                    { name: 'äºšæ´²é¾™', avgPrice: 162000, retention: 74 }
                ]
            },
            'å®é©¬3ç³»': {
                brand: 'å®é©¬',
                model: '3ç³»',
                englishName: 'BMW 3 Series',
                category: 'ä¸­å‹è±ªåè½¿è½¦',
                specs: '2.0T è‡ªåŠ¨ | å‰ç½®åé©±',
                newCarPrice: 325000,
                years: {
                    '2023': { avgPrice: 285000, minPrice: 258000, maxPrice: 318000, retention: 88, volume: 1560 },
                    '2022': { avgPrice: 262000, minPrice: 238000, maxPrice: 292000, retention: 81, volume: 2340 },
                    '2021': { avgPrice: 238000, minPrice: 215000, maxPrice: 265000, retention: 73, volume: 1980 },
                    '2020': { avgPrice: 215000, minPrice: 192000, maxPrice: 238000, retention: 66, volume: 1560 }
                },
                priceHistory: {
                    '6m': [282000, 283000, 284000, 285000, 285000, 285000],
                    '1y': [298000, 295000, 292000, 288000, 285000, 283000, 282000, 283000, 284000, 285000, 285000, 285000],
                    '2y': [315000, 310000, 305000, 300000, 295000, 292000, 288000, 285000, 283000, 282000, 281000, 282000, 283000, 284000, 285000, 285000, 284000, 283000, 282000, 281000, 280000, 281000, 282000, 283000]
                },
                competitors: [
                    { name: 'å¥”é©°Cçº§', avgPrice: 268000, retention: 82 },
                    { name: 'å¥¥è¿ªA4L', avgPrice: 245000, retention: 75 },
                    { name: 'é›·å…‹è¨æ–¯ES', avgPrice: 285000, retention: 85 },
                    { name: 'å‡¯è¿ªæ‹‰å…‹CT5', avgPrice: 215000, retention: 72 }
                ]
            },
            'å¡ç½—æ‹‰': {
                brand: 'ä¸°ç”°',
                model: 'å¡ç½—æ‹‰',
                englishName: 'Toyota Corolla',
                category: 'ç´§å‡‘å‹è½¿è½¦',
                specs: '1.2T CVT | å‰ç½®å‰é©±',
                newCarPrice: 128800,
                years: {
                    '2023': { avgPrice: 108000, minPrice: 98000, maxPrice: 118000, retention: 84, volume: 3250 },
                    '2022': { avgPrice: 98000, minPrice: 88000, maxPrice: 108000, retention: 76, volume: 4680 },
                    '2021': { avgPrice: 88000, minPrice: 78000, maxPrice: 98000, retention: 68, volume: 4120 },
                    '2020': { avgPrice: 78000, minPrice: 68000, maxPrice: 88000, retention: 61, volume: 3250 }
                },
                priceHistory: {
                    '6m': [106000, 107000, 107000, 108000, 108000, 108000],
                    '1y': [112000, 111000, 110000, 109000, 108000, 107000, 106000, 107000, 107000, 108000, 108000, 108000],
                    '2y': [118000, 116000, 114000, 112000, 110000, 109000, 108000, 107000, 106000, 105000, 106000, 107000, 107000, 108000, 108000, 108000, 107000, 106000, 105000, 104000, 105000, 106000, 107000, 108000]
                },
                competitors: [
                    { name: 'è½©é€¸', avgPrice: 88000, retention: 72 },
                    { name: 'æœ—é€¸', avgPrice: 92000, retention: 74 },
                    { name: 'æ€åŸŸ', avgPrice: 105000, retention: 78 },
                    { name: 'å®æ¥', avgPrice: 85000, retention: 70 }
                ]
            },
            'CR-V': {
                brand: 'æœ¬ç”°',
                model: 'CR-V',
                englishName: 'Honda CR-V',
                category: 'ç´§å‡‘å‹SUV',
                specs: '1.5T CVT | å‰ç½®å‰é©±',
                newCarPrice: 209800,
                years: {
                    '2023': { avgPrice: 178000, minPrice: 162000, maxPrice: 198000, retention: 85, volume: 1890 },
                    '2022': { avgPrice: 162000, minPrice: 148000, maxPrice: 182000, retention: 77, volume: 2680 },
                    '2021': { avgPrice: 148000, minPrice: 135000, maxPrice: 165000, retention: 71, volume: 2340 },
                    '2020': { avgPrice: 135000, minPrice: 118000, maxPrice: 152000, retention: 64, volume: 1890 }
                },
                priceHistory: {
                    '6m': [175000, 176000, 177000, 178000, 178000, 178000],
                    '1y': [185000, 183000, 181000, 179000, 177000, 176000, 175000, 176000, 177000, 178000, 178000, 178000],
                    '2y': [195000, 192000, 189000, 186000, 183000, 181000, 179000, 177000, 175000, 174000, 175000, 176000, 177000, 178000, 178000, 178000, 177000, 176000, 175000, 174000, 175000, 176000, 177000, 178000]
                },
                competitors: [
                    { name: 'RAV4', avgPrice: 168000, retention: 79 },
                    { name: 'é€”è§‚L', avgPrice: 158000, retention: 76 },
                    { name: 'å¥‡éª', avgPrice: 142000, retention: 68 },
                    { name: 'çš“å½±', avgPrice: 165000, retention: 78 }
                ]
            }
        };
        
        let currentQueryCar = null;
        let currentQueryYear = null;
        let currentTimeRange = '6m';
        
        // ==========================================
        // Initialization
        // ==========================================
        document.addEventListener('DOMContentLoaded', function() {
            var savedCode = '';
            try { savedCode = localStorage.getItem('selectedCountry') || ''; } catch (e) {}
            if (savedCode) {
                var c = SUPPORTED_COUNTRIES.find(function(x) { return x.code === savedCode; });
                if (c) { currentCountry = c; }
            }
            document.getElementById('currentFlag').textContent = currentCountry.flag;
            document.getElementById('currentCountry').textContent = currentCountry.name;
            document.getElementById('currencyBadge').textContent = currentCountry.currency;
            document.getElementById('exchangeRate').textContent = currentCountry.rate.toFixed(2);
            AgentManager.init(currentCountry.agent);
            
            Chart.defaults.responsive = true;
            Chart.defaults.maintainAspectRatio = false;
            Chart.defaults.plugins.legend.labels.boxWidth = 12;
            Chart.defaults.plugins.legend.labels.font = { size: 11 };
            
            // Mobile-specific chart config (ç§»åŠ¨ç«¯å›¾è¡¨é…ç½®)
            if (window.innerWidth <= 768) {
                Chart.defaults.plugins.legend.display = false;
                Chart.defaults.plugins.tooltip.titleFont = { size: 12 };
                Chart.defaults.plugins.tooltip.bodyFont = { size: 11 };
            }
            
            initYearSelect();
            // Old calculator functions removed - now using floating widget
            renderCountryList();
            initMarketCharts();
            updateMarketData();
            loadSavedVehicles();
            updateCurrencyDisplay();
            updateAgentIndicator();
            
            // Initialize touch optimizations (åˆå§‹åŒ–è§¦æ‘¸ä¼˜åŒ–)
            initTouchOptimizations();
            
            // Handle window resize (å¤„ç†çª—å£å¤§å°å˜åŒ–)
            let resizeTimer;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(function() {
                    // Resize all charts
                    Object.values(charts).forEach(chart => {
                        if (chart && typeof chart.resize === 'function') {
                            chart.resize();
                        }
                    });
                }, 250);
            });
            
            // Handle orientation change (å¤„ç†å±å¹•æ—‹è½¬)
            window.addEventListener('orientationchange', function() {
                setTimeout(function() {
                    Object.values(charts).forEach(chart => {
                        if (chart && typeof chart.resize === 'function') {
                            chart.resize();
                        }
                    });
                }, 300);
            });
        });
        
        // Touch Optimizations (è§¦æ‘¸ä¼˜åŒ–)
        function initTouchOptimizations() {
            // Prevent zoom on double tap (é˜²æ­¢åŒå‡»ç¼©æ”¾)
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(e) {
                const now = Date.now();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, { passive: false });
            
            // Add touch feedback (æ·»åŠ è§¦æ‘¸åé¦ˆ)
            document.querySelectorAll('.btn, .nav-item, .mobile-nav-item, .card').forEach(el => {
                el.addEventListener('touchstart', function() {
                    this.style.transform = 'scale(0.98)';
                }, { passive: true });
                
                el.addEventListener('touchend', function() {
                    this.style.transform = '';
                }, { passive: true });
            });
            
            // Smooth scroll for anchor links (é”šç‚¹é“¾æ¥å¹³æ»‘æ»šåŠ¨)
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function(e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({ behavior: 'smooth' });
                    }
                });
            });
        }
        
        // ==========================================
        // Country & Currency
        // ==========================================
        function renderCountryList() {
            const container = document.getElementById('countryList');
            container.innerHTML = SUPPORTED_COUNTRIES.map(country => `
                <div class="country-card border-2 border-slate-100 rounded-xl p-4 ${country.code === currentCountry.code ? 'selected' : ''}" 
                     onclick="selectCountry('${country.code}')">
                    <div class="text-3xl mb-2">${country.flag}</div>
                    <div class="font-medium text-sm">${country.name}</div>
                    <div class="text-xs text-slate-500">${country.currency}</div>
                </div>
            `).join('');
        }
        
        function selectCountry(code) {
            currentCountry = SUPPORTED_COUNTRIES.find(c => c.code === code);
            document.getElementById('currentFlag').textContent = currentCountry.flag;
            document.getElementById('currentCountry').textContent = currentCountry.name;
            document.getElementById('currencyBadge').textContent = currentCountry.currency;
            document.getElementById('exchangeRate').textContent = currentCountry.rate.toFixed(2);
            
            document.querySelectorAll('.currency-label').forEach(el => {
                el.textContent = currentCountry.currency;
            });
            
            // Multi-Agent: Switch agent based on country (å¤šAgentï¼šæ ¹æ®å›½å®¶åˆ‡æ¢Agent)
            AgentManager.switchAgentByCountry(code);
            updateAgentIndicator();
            
            updateCurrencyDisplay();
            renderCountryList();
            closeCountryModal();
            showToast(`å·²åˆ‡æ¢åˆ° ${currentCountry.name} | ${currentCountry.currency} | Agent: ${currentAgent?.config.name || 'Default'}`);
            
            // å…¨é‡åˆ·æ–°ï¼šå¸‚åœºçœ‹æ¿
            updateMarketData();
            // è‹¥å½“å‰åœ¨è½¦å‹æŸ¥è¯¢ç»“æœé¡µï¼Œç”¨æ–°è´§å¸é‡ç»˜
            if (currentQueryCar) {
                updateQueryCarInfo();
                renderQueryCharts();
                renderDealerTable();
            }
            // è‹¥è®¡ç®—å™¨å·²æ‰“å¼€ï¼Œåˆ·æ–°äººæ°‘å¸æ¢ç®—
            const calcEl = document.getElementById('calcWidget');
            if (calcEl && calcEl.style.display !== 'none' && typeof widgetCalculate === 'function') {
                widgetCalculate();
            }
            try { localStorage.setItem('selectedCountry', code); } catch (e) {}
        }
        
        function openCountryModal() {
            document.getElementById('countryModal').classList.remove('hidden');
            document.getElementById('countryModal').classList.add('flex');
        }
        
        function closeCountryModal() {
            document.getElementById('countryModal').classList.add('hidden');
            document.getElementById('countryModal').classList.remove('flex');
        }
        
        function updateAgentIndicator() {
            // Update or create Agent indicator in header
            let indicator = document.getElementById('agentIndicator');
            if (!indicator && currentAgent) {
                indicator = document.createElement('div');
                indicator.id = 'agentIndicator';
                indicator.className = 'ml-2 px-2 py-1 rounded text-xs font-medium';
                const header = document.querySelector('header .flex.items-center');
                if (header) {
                    header.appendChild(indicator);
                }
            }
            
            if (indicator && currentAgent) {
                indicator.textContent = currentAgent.config.name;
                indicator.style.backgroundColor = currentAgent.config.ui.primaryColor + '20'; // 20% opacity
                indicator.style.color = currentAgent.config.ui.primaryColor;
            }
        }
        
        function updateCurrencyDisplay() {
            // Update all currency labels
            document.querySelectorAll('.currency-label').forEach(el => {
                el.textContent = currentCountry.currency;
            });
            // Update calculator widget currency
            const widgetCurrency = document.getElementById('widgetCurrency');
            if (widgetCurrency) {
                widgetCurrency.textContent = currentCountry.currency;
            }
        }
        
        // ==========================================
        // Tab Navigation
        // ==========================================
        // Current active tab
        let currentTab = 'market';
        
        function switchTab(tabName) {
            currentTab = tabName;
            
            // Update desktop nav buttons
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('bg-white', 'text-slate-600');
            });
            event.target.closest('.nav-item').classList.add('active');
            event.target.closest('.nav-item').classList.remove('bg-white', 'text-slate-600');
            
            // Update mobile nav
            updateMobileNav(tabName);
            
            // Show section
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(`section-${tabName}`).classList.add('active');
            
            // Refresh charts if needed
            if (tabName === 'market' && charts.priceTrend) {
                Object.values(charts).forEach(chart => chart.resize());
            }
            
            // Scroll to top on mobile
            if (window.innerWidth <= 768) {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        
        // Mobile navigation switch
        function switchMobileTab(tabName) {
            currentTab = tabName;
            
            // Update mobile nav
            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.mobile-nav-item').classList.add('active');
            
            // Update desktop nav
            document.querySelectorAll('.nav-item').forEach((btn, index) => {
                const tabs = ['market', 'query', 'vehicle', 'database'];
                btn.classList.remove('active');
                btn.classList.add('bg-white', 'text-slate-600');
                if (tabs[index] === tabName) {
                    btn.classList.add('active');
                    btn.classList.remove('bg-white', 'text-slate-600');
                }
            });
            
            // Show section
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(`section-${tabName}`).classList.add('active');
            
            // Refresh charts if needed
            if (tabName === 'market' && charts.priceTrend) {
                Object.values(charts).forEach(chart => chart.resize());
            }
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Update mobile nav state
        function updateMobileNav(tabName) {
            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.tab === tabName) {
                    item.classList.add('active');
                }
            });
        }
        
        // ==========================================
        // Market Tab Switching
        // ==========================================
        let currentMarketTab = 'overview';
        let selectedBrand = 'toyota';
        let selectedModelsForCompare = [];
        
        function switchMarketTab(tabName) {
            currentMarketTab = tabName;
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // Show/hide content
            document.querySelectorAll('.market-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`market-${tabName}`).classList.remove('hidden');
            
            // Initialize brand analysis if needed
            if (tabName === 'brand-analysis' && !charts.brandPrice) {
                initBrandAnalysis();
            }
        }
        
        // ==========================================
        // Brand & Model Data
        // ==========================================
        const BRAND_MODELS_DATA = {
            toyota: {
                name: 'ä¸°ç”°',
                nameEn: 'Toyota',
                models: [
                    { name: 'Corolla Altis', avgPrice: 85800, minPrice: 68000, maxPrice: 108000, volume: 2840, retention: 72, trend: 'up', trendValue: 2.3 },
                    { name: 'Camry', avgPrice: 128000, minPrice: 98000, maxPrice: 158000, volume: 1820, retention: 68, trend: 'flat', trendValue: 0 },
                    { name: 'RAV4', avgPrice: 135000, minPrice: 108000, maxPrice: 168000, volume: 1650, retention: 70, trend: 'up', trendValue: 1.8 },
                    { name: 'Hilux', avgPrice: 118000, minPrice: 95000, maxPrice: 145000, volume: 1420, retention: 75, trend: 'up', trendValue: 3.2 },
                    { name: 'Vios', avgPrice: 62800, minPrice: 48000, maxPrice: 78000, volume: 2100, retention: 65, trend: 'down', trendValue: -1.5 },
                    { name: 'Fortuner', avgPrice: 158000, minPrice: 128000, maxPrice: 195000, volume: 980, retention: 71, trend: 'up', trendValue: 2.1 },
                    { name: 'Yaris Cross', avgPrice: 95800, minPrice: 78000, maxPrice: 118000, volume: 1200, retention: 69, trend: 'up', trendValue: 1.2 },
                ]
            },
            honda: {
                name: 'æœ¬ç”°',
                nameEn: 'Honda',
                models: [
                    { name: 'Civic', avgPrice: 92000, minPrice: 72000, maxPrice: 115000, volume: 2150, retention: 70, trend: 'up', trendValue: 1.5 },
                    { name: 'City', avgPrice: 68800, minPrice: 52000, maxPrice: 85000, volume: 1980, retention: 68, trend: 'flat', trendValue: 0 },
                    { name: 'CR-V', avgPrice: 138000, minPrice: 110000, maxPrice: 172000, volume: 1520, retention: 69, trend: 'up', trendValue: 2.0 },
                    { name: 'Accord', avgPrice: 118000, minPrice: 92000, maxPrice: 148000, volume: 890, retention: 66, trend: 'down', trendValue: -0.8 },
                    { name: 'HR-V', avgPrice: 98800, minPrice: 78000, maxPrice: 122000, volume: 1380, retention: 67, trend: 'up', trendValue: 1.0 },
                    { name: 'Jazz', avgPrice: 55800, minPrice: 42000, maxPrice: 70000, volume: 1150, retention: 64, trend: 'down', trendValue: -2.0 },
                ]
            },
            nissan: {
                name: 'æ—¥äº§',
                nameEn: 'Nissan',
                models: [
                    { name: 'Sylphy', avgPrice: 78800, minPrice: 62000, maxPrice: 98000, volume: 1650, retention: 65, trend: 'flat', trendValue: 0 },
                    { name: 'X-Trail', avgPrice: 122000, minPrice: 98000, maxPrice: 152000, volume: 980, retention: 64, trend: 'up', trendValue: 1.2 },
                    { name: 'Qashqai', avgPrice: 108000, minPrice: 88000, maxPrice: 132000, volume: 820, retention: 63, trend: 'up', trendValue: 0.8 },
                    { name: 'Navara', avgPrice: 115000, minPrice: 92000, maxPrice: 142000, volume: 750, retention: 68, trend: 'up', trendValue: 2.5 },
                    { name: 'Almera', avgPrice: 62800, minPrice: 48000, maxPrice: 78000, volume: 920, retention: 62, trend: 'down', trendValue: -1.2 },
                ]
            },
            bmw: {
                name: 'å®é©¬',
                nameEn: 'BMW',
                models: [
                    { name: '3 Series', avgPrice: 185000, minPrice: 148000, maxPrice: 235000, volume: 1560, retention: 62, trend: 'up', trendValue: 1.8 },
                    { name: '5 Series', avgPrice: 228000, minPrice: 185000, maxPrice: 288000, volume: 980, retention: 60, trend: 'flat', trendValue: 0 },
                    { name: 'X1', avgPrice: 142000, minPrice: 115000, maxPrice: 178000, volume: 1120, retention: 61, trend: 'up', trendValue: 1.2 },
                    { name: 'X3', avgPrice: 188000, minPrice: 152000, maxPrice: 238000, volume: 890, retention: 63, trend: 'up', trendValue: 1.5 },
                    { name: 'X5', avgPrice: 285000, minPrice: 228000, maxPrice: 358000, volume: 520, retention: 65, trend: 'up', trendValue: 2.0 },
                    { name: '1 Series', avgPrice: 108000, minPrice: 88000, maxPrice: 135000, volume: 680, retention: 58, trend: 'down', trendValue: -1.0 },
                ]
            },
            mercedes: {
                name: 'å¥”é©°',
                nameEn: 'Mercedes-Benz',
                models: [
                    { name: 'C-Class', avgPrice: 195000, minPrice: 158000, maxPrice: 245000, volume: 1420, retention: 60, trend: 'flat', trendValue: 0 },
                    { name: 'E-Class', avgPrice: 258000, minPrice: 208000, maxPrice: 325000, volume: 880, retention: 58, trend: 'up', trendValue: 0.5 },
                    { name: 'GLA', avgPrice: 138000, minPrice: 112000, maxPrice: 172000, volume: 650, retention: 59, trend: 'up', trendValue: 1.0 },
                    { name: 'GLC', avgPrice: 198000, minPrice: 162000, maxPrice: 248000, volume: 720, retention: 61, trend: 'up', trendValue: 1.2 },
                    { name: 'A-Class', avgPrice: 118000, minPrice: 95000, maxPrice: 148000, volume: 580, retention: 56, trend: 'down', trendValue: -1.5 },
                ]
            },
            mazda: {
                name: 'é©¬è‡ªè¾¾',
                nameEn: 'Mazda',
                models: [
                    { name: 'Mazda3', avgPrice: 82800, minPrice: 65000, maxPrice: 102000, volume: 1180, retention: 66, trend: 'flat', trendValue: 0 },
                    { name: 'CX-5', avgPrice: 118000, minPrice: 95000, maxPrice: 148000, volume: 920, retention: 67, trend: 'up', trendValue: 1.5 },
                    { name: 'Mazda2', avgPrice: 58800, minPrice: 46000, maxPrice: 72000, volume: 850, retention: 64, trend: 'down', trendValue: -1.0 },
                    { name: 'CX-3', avgPrice: 92800, minPrice: 75000, maxPrice: 115000, volume: 680, retention: 65, trend: 'flat', trendValue: 0 },
                    { name: '6', avgPrice: 108000, minPrice: 88000, maxPrice: 135000, volume: 420, retention: 63, trend: 'down', trendValue: -0.5 },
                ]
            },
            mitsubishi: {
                name: 'ä¸‰è±',
                nameEn: 'Mitsubishi',
                models: [
                    { name: 'Attrage', avgPrice: 52800, minPrice: 40000, maxPrice: 65000, volume: 780, retention: 62, trend: 'down', trendValue: -1.8 },
                    { name: 'Xpander', avgPrice: 78800, minPrice: 62000, maxPrice: 98000, volume: 1120, retention: 64, trend: 'up', trendValue: 2.0 },
                    { name: 'Triton', avgPrice: 108000, minPrice: 88000, maxPrice: 132000, volume: 680, retention: 66, trend: 'up', trendValue: 1.5 },
                    { name: 'Outlander', avgPrice: 128000, minPrice: 102000, maxPrice: 158000, volume: 380, retention: 63, trend: 'flat', trendValue: 0 },
                ]
            },
            hyundai: {
                name: 'ç°ä»£',
                nameEn: 'Hyundai',
                models: [
                    { name: 'Avante', avgPrice: 78800, minPrice: 62000, maxPrice: 98000, volume: 920, retention: 63, trend: 'up', trendValue: 1.0 },
                    { name: 'Tucson', avgPrice: 118000, minPrice: 95000, maxPrice: 148000, volume: 680, retention: 64, trend: 'up', trendValue: 1.2 },
                    { name: 'Creta', avgPrice: 82800, minPrice: 66000, maxPrice: 102000, volume: 580, retention: 62, trend: 'flat', trendValue: 0 },
                    { name: 'i30', avgPrice: 68800, minPrice: 54000, maxPrice: 85000, volume: 420, retention: 61, trend: 'down', trendValue: -0.8 },
                ]
            },
            kia: {
                name: 'èµ·äºš',
                nameEn: 'Kia',
                models: [
                    { name: 'Cerato', avgPrice: 76800, minPrice: 60000, maxPrice: 95000, volume: 780, retention: 62, trend: 'flat', trendValue: 0 },
                    { name: 'Sportage', avgPrice: 115000, minPrice: 92000, maxPrice: 142000, volume: 620, retention: 63, trend: 'up', trendValue: 1.0 },
                    { name: 'Seltos', avgPrice: 86800, minPrice: 69000, maxPrice: 108000, volume: 520, retention: 61, trend: 'up', trendValue: 0.8 },
                    { name: 'Stonic', avgPrice: 62800, minPrice: 50000, maxPrice: 78000, volume: 380, retention: 60, trend: 'down', trendValue: -0.5 },
                ]
            },
            audi: {
                name: 'å¥¥è¿ª',
                nameEn: 'Audi',
                models: [
                    { name: 'A3', avgPrice: 128000, minPrice: 102000, maxPrice: 160000, volume: 480, retention: 58, trend: 'up', trendValue: 0.5 },
                    { name: 'A4', avgPrice: 168000, minPrice: 135000, maxPrice: 210000, volume: 380, retention: 59, trend: 'flat', trendValue: 0 },
                    { name: 'Q3', avgPrice: 148000, minPrice: 118000, maxPrice: 185000, volume: 420, retention: 60, trend: 'up', trendValue: 1.0 },
                    { name: 'Q5', avgPrice: 198000, minPrice: 158000, maxPrice: 248000, volume: 320, retention: 62, trend: 'up', trendValue: 1.2 },
                ]
            }
        };
        
        // ==========================================
        // Brand Analysis Functions
        // ==========================================
        function initBrandAnalysis() {
            renderBrandFilter();
            selectBrand('toyota');
        }
        
        function renderBrandFilter() {
            const container = document.getElementById('brandFilterList');
            const brands = Object.keys(BRAND_MODELS_DATA);
            
            container.innerHTML = brands.map(brandKey => {
                const brand = BRAND_MODELS_DATA[brandKey];
                return `
                    <button class="brand-filter-btn px-4 py-2 rounded-lg bg-white border border-slate-200 text-sm font-medium ${brandKey === selectedBrand ? 'active' : ''}" 
                            onclick="selectBrand('${brandKey}')" data-brand="${brandKey}">
                        ${brand.name}
                    </button>
                `;
            }).join('');
        }
        
        function selectBrand(brandKey) {
            selectedBrand = brandKey;
            selectedModelsForCompare = [];
            
            // Update filter buttons
            document.querySelectorAll('.brand-filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.brand === brandKey);
            });
            
            const brand = BRAND_MODELS_DATA[brandKey];
            
            // Update titles
            document.getElementById('brandChartTitle').textContent = `${brand.name} - è½¦å‹ä»·æ ¼åˆ†å¸ƒ`;
            document.getElementById('brandTableTitle').textContent = `${brand.name}è½¦å‹ä»·æ ¼åˆ†æ`;
            
            // Render stats
            renderBrandStats(brand);
            
            // Render chart
            renderBrandPriceChart(brand);
            
            // Render table
            renderBrandModelTable(brand);
            
            // Hide comparison section
            document.getElementById('comparisonSection').style.display = 'none';
        }
        
        function renderBrandStats(brand) {
            const models = brand.models;
            const avgPrice = Math.round(models.reduce((sum, m) => sum + m.avgPrice, 0) / models.length);
            const totalVolume = models.reduce((sum, m) => sum + m.volume, 0);
            const avgRetention = Math.round(models.reduce((sum, m) => sum + m.retention, 0) / models.length);
            const risingModels = models.filter(m => m.trend === 'up').length;
            
            const container = document.getElementById('brandSummaryStats');
            container.innerHTML = `
                <div class="card stat-card p-4">
                    <p class="text-xs text-slate-500 mb-1">å“ç‰Œå‡ä»·</p>
                    <p class="text-xl font-bold text-slate-800">${currentCountry.symbol}${avgPrice.toLocaleString()}</p>
                </div>
                <div class="card stat-card success p-4">
                    <p class="text-xs text-slate-500 mb-1">æœˆé”€æ€»é‡</p>
                    <p class="text-xl font-bold text-slate-800">${totalVolume.toLocaleString()}</p>
                </div>
                <div class="card stat-card warning p-4">
                    <p class="text-xs text-slate-500 mb-1">å¹³å‡ä¿å€¼ç‡</p>
                    <p class="text-xl font-bold text-slate-800">${avgRetention}%</p>
                </div>
                <div class="card stat-card p-4" style="border-left-color: #8b5cf6;">
                    <p class="text-xs text-slate-500 mb-1">æ¶¨ä»·è½¦å‹</p>
                    <p class="text-xl font-bold text-slate-800">${risingModels}æ¬¾</p>
                </div>
            `;
        }
        
        function renderBrandPriceChart(brand) {
            const ctx = document.getElementById('brandPriceChart');
            
            if (charts.brandPrice) {
                charts.brandPrice.destroy();
            }
            
            const models = brand.models;
            const labels = models.map(m => m.name);
            const avgPrices = models.map(m => m.avgPrice);
            const minPrices = models.map(m => m.minPrice);
            const maxPrices = models.map(m => m.maxPrice);
            
            charts.brandPrice = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'æœ€é«˜ä»·',
                            data: maxPrices,
                            backgroundColor: 'rgba(239, 68, 68, 0.6)',
                            borderColor: '#ef4444',
                            borderWidth: 1
                        },
                        {
                            label: 'å‡ä»·',
                            data: avgPrices,
                            backgroundColor: 'rgba(59, 130, 246, 0.8)',
                            borderColor: '#3b82f6',
                            borderWidth: 1
                        },
                        {
                            label: 'æœ€ä½ä»·',
                            data: minPrices,
                            backgroundColor: 'rgba(16, 185, 129, 0.6)',
                            borderColor: '#10b981',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + currentCountry.symbol + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return currentCountry.symbol + (value / 1000) + 'k';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderBrandModelTable(brand) {
            const tbody = document.getElementById('brandModelTable');
            const models = [...brand.models]; // Copy for sorting
            
            // Apply sorting
            const sortBy = document.getElementById('sortBy').value;
            switch(sortBy) {
                case 'price-desc':
                    models.sort((a, b) => b.avgPrice - a.avgPrice);
                    break;
                case 'price-asc':
                    models.sort((a, b) => a.avgPrice - b.avgPrice);
                    break;
                case 'volume':
                    models.sort((a, b) => b.volume - a.volume);
                    break;
                case 'retention':
                    models.sort((a, b) => b.retention - a.retention);
                    break;
            }
            
            tbody.innerHTML = models.map((model, index) => {
                const trendIcon = model.trend === 'up' ? 'â†‘' : model.trend === 'down' ? 'â†“' : 'â†’';
                const trendClass = model.trend === 'up' ? 'trend-up' : model.trend === 'down' ? 'trend-down' : 'trend-flat';
                const isSelected = selectedModelsForCompare.includes(model.name);
                
                return `
                    <tr class="model-row ${isSelected ? 'selected' : ''}" data-model="${model.name}">
                        <td class="py-3">
                            <div class="flex items-center gap-2">
                                <input type="checkbox" class="compare-checkbox" 
                                       ${isSelected ? 'checked' : ''} 
                                       onchange="toggleModelCompare('${model.name}')"
                                       onclick="event.stopPropagation()">
                                <span class="font-medium">${brand.nameEn} ${model.name}</span>
                            </div>
                        </td>
                        <td class="py-3 text-right font-semibold">${currentCountry.symbol}${model.avgPrice.toLocaleString()}</td>
                        <td class="py-3 text-right text-slate-500">${currentCountry.symbol}${model.minPrice.toLocaleString()}</td>
                        <td class="py-3 text-right text-slate-500">${currentCountry.symbol}${model.maxPrice.toLocaleString()}</td>
                        <td class="py-3 text-right">${model.volume.toLocaleString()}</td>
                        <td class="py-3 text-right">
                            <span class="px-2 py-1 rounded-full text-xs ${model.retention >= 70 ? 'bg-green-100 text-green-600' : model.retention >= 60 ? 'bg-yellow-100 text-yellow-600' : 'bg-red-100 text-red-600'}">
                                ${model.retention}%
                            </span>
                        </td>
                        <td class="py-3 text-right">
                            <span class="${trendClass} font-medium">
                                ${trendIcon} ${Math.abs(model.trendValue)}%
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function sortModelTable() {
            const brand = BRAND_MODELS_DATA[selectedBrand];
            renderBrandModelTable(brand);
        }
        
        function toggleModelCompare(modelName) {
            const index = selectedModelsForCompare.indexOf(modelName);
            if (index > -1) {
                selectedModelsForCompare.splice(index, 1);
            } else {
                if (selectedModelsForCompare.length < 3) {
                    selectedModelsForCompare.push(modelName);
                } else {
                    showToast('æœ€å¤šé€‰æ‹©3æ¬¾è½¦å‹è¿›è¡Œå¯¹æ¯”');
                    return;
                }
            }
            
            const brand = BRAND_MODELS_DATA[selectedBrand];
            renderBrandModelTable(brand);
            
            if (selectedModelsForCompare.length >= 2) {
                showComparison(brand);
            } else {
                document.getElementById('comparisonSection').style.display = 'none';
            }
        }
        
        function showComparison(brand) {
            const section = document.getElementById('comparisonSection');
            section.style.display = 'block';
            
            const models = brand.models.filter(m => selectedModelsForCompare.includes(m.name));
            
            // Render comparison chart
            const ctx = document.getElementById('comparisonChart');
            if (charts.comparison) {
                charts.comparison.destroy();
            }
            
            charts.comparison = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['ä»·æ ¼ä¼˜åŠ¿', 'ä¿å€¼ç‡', 'é”€é‡çƒ­åº¦', 'ä»·æ ¼ç¨³å®šæ€§', 'å¸‚åœºè®¤å¯åº¦'],
                    datasets: models.map((model, index) => ({
                        label: model.name,
                        data: [
                            100 - (model.avgPrice / 300000) * 100,
                            model.retention,
                            Math.min(100, model.volume / 30),
                            100 - Math.abs(model.trendValue) * 10,
                            Math.min(100, model.volume / 20 + 50)
                        ],
                        backgroundColor: ['rgba(59, 130, 246, 0.2)', 'rgba(16, 185, 129, 0.2)', 'rgba(245, 158, 11, 0.2)'][index],
                        borderColor: ['#3b82f6', '#10b981', '#f59e0b'][index],
                        borderWidth: 2
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            min: 0,
                            max: 100
                        }
                    }
                }
            });
            
            // Render comparison details
            const detailsDiv = document.getElementById('comparisonDetails');
            const rate = currentCountry.rate;
            const symbol = currentCountry.symbol;
            
            detailsDiv.innerHTML = models.map(model => `
                <div class="bg-slate-50 rounded-xl p-4">
                    <h4 class="font-semibold text-lg mb-3">${brand.nameEn} ${model.name}</h4>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-slate-500">å‡ä»·</span>
                            <span class="font-medium">${symbol}${Math.round(model.avgPrice / rate).toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-500">ä»·æ ¼åŒºé—´</span>
                            <span class="font-medium">${symbol}${Math.round(model.minPrice / rate).toLocaleString()} - ${symbol}${Math.round(model.maxPrice / rate).toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-500">æœˆé”€é‡</span>
                            <span class="font-medium">${model.volume.toLocaleString()}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-500">ä¿å€¼ç‡</span>
                            <span class="font-medium ${model.retention >= 70 ? 'text-green-500' : model.retention >= 60 ? 'text-yellow-500' : 'text-red-500'}">${model.retention}%</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-500">ä»·æ ¼è¶‹åŠ¿</span>
                            <span class="font-medium ${model.trend === 'up' ? 'text-green-500' : model.trend === 'down' ? 'text-red-500' : 'text-slate-500'}">
                                ${model.trend === 'up' ? 'â†‘ ä¸Šæ¶¨' : model.trend === 'down' ? 'â†“ ä¸‹è·Œ' : 'â†’ æŒå¹³'} ${Math.abs(model.trendValue)}%
                            </span>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Scroll to comparison
            section.scrollIntoView({ behavior: 'smooth' });
        }
        
        // ==========================================
        // Market Analysis Charts
        // ==========================================
        function initMarketCharts() {
            // Price Trend Chart
            const priceCtx = document.getElementById('priceTrendChart').getContext('2d');
            charts.priceTrend = new Chart(priceCtx, {
                type: 'line',
                data: {
                    labels: ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'],
                    datasets: [{
                        label: 'å¹³å‡æˆäº¤ä»·',
                        data: [85000, 86000, 84500, 87000, 88000, 86500, 89000, 90000, 88500, 91000, 92000, 91500],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'å¸‚åœºæŒ‚ç‰Œä»·',
                        data: [92000, 93000, 91500, 94000, 95000, 93500, 96000, 97000, 95500, 98000, 99000, 98500],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    scales: { y: { beginAtZero: false } }
                }
            });
            
            // Brand Share Chart
            const brandCtx = document.getElementById('brandShareChart').getContext('2d');
            charts.brandShare = new Chart(brandCtx, {
                type: 'doughnut',
                data: {
                    labels: ['ä¸°ç”°', 'æœ¬ç”°', 'å®é©¬', 'å¥”é©°', 'æ—¥äº§', 'å…¶ä»–'],
                    datasets: [{
                        data: [28, 18, 15, 12, 10, 17],
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#94a3b8']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
            
            // Age Distribution Chart
            const ageCtx = document.getElementById('ageDistChart').getContext('2d');
            charts.ageDist = new Chart(ageCtx, {
                type: 'bar',
                data: {
                    labels: ['1-3å¹´', '3-5å¹´', '5-7å¹´', '7-10å¹´', '10å¹´ä»¥ä¸Š'],
                    datasets: [{
                        label: 'è½¦è¾†å æ¯”',
                        data: [25, 32, 22, 15, 6],
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
            
            // Price Range Chart
            const rangeCtx = document.getElementById('priceRangeChart').getContext('2d');
            charts.priceRange = new Chart(rangeCtx, {
                type: 'bar',
                data: {
                    labels: ['<5ä¸‡', '5-10ä¸‡', '10-15ä¸‡', '15-25ä¸‡', '25-40ä¸‡', '>40ä¸‡'],
                    datasets: [{
                        label: 'äº¤æ˜“é‡',
                        data: [18, 28, 24, 18, 8, 4],
                        backgroundColor: '#10b981'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
            
            // Render top models table
            renderTopModels();
        }
        
        function renderTopModels() {
            const models = [
                { rank: 1, model: 'Toyota Corolla Altis', brand: 'ä¸°ç”°', price: 85800, volume: 2840, retention: '72%' },
                { rank: 2, model: 'Honda Civic', brand: 'æœ¬ç”°', price: 92000, volume: 2150, retention: '70%' },
                { rank: 3, model: 'Toyota Camry', brand: 'ä¸°ç”°', price: 128000, volume: 1820, retention: '68%' },
                { rank: 4, model: 'BMW 3 Series', brand: 'å®é©¬', price: 185000, volume: 1560, retention: '62%' },
                { rank: 5, model: 'Mercedes C-Class', brand: 'å¥”é©°', price: 195000, volume: 1420, retention: '60%' },
            ];
            
            document.getElementById('topModelsTable').innerHTML = models.map(m => `
                <tr class="border-b border-slate-50 last:border-0">
                    <td class="py-3">
                        <span class="inline-flex items-center justify-center w-6 h-6 rounded-full ${m.rank <= 3 ? 'bg-blue-100 text-blue-600' : 'bg-slate-100 text-slate-600'} text-xs font-bold">${m.rank}</span>
                    </td>
                    <td class="py-3 font-medium">${m.model}</td>
                    <td class="py-3 text-slate-500">${m.brand}</td>
                    <td class="py-3 text-right font-medium">${currentCountry.symbol}${m.price.toLocaleString()}</td>
                    <td class="py-3 text-right">${m.volume.toLocaleString()}</td>
                    <td class="py-3 text-right text-green-500">${m.retention}</td>
                </tr>
            `).join('');
        }
        
        function updateMarketData() {
            var multipliers = {
                'CN': 1, 'SG': 1, 'MY': 0.3, 'TH': 0.25, 'ID': 0.15, 'VN': 0.18,
                'PH': 0.12, 'MM': 0.08, 'KH': 0.06, 'LA': 0.05, 'BN': 1
            };
            var multiplier = multipliers[currentCountry.code] || 1;
            var baseSize = 2.8;
            var baseVolume = 15280;
            document.getElementById('marketSize').textContent = 'Â¥' + (baseSize * multiplier).toFixed(1) + 'B';
            document.getElementById('monthlyVolume').textContent = Math.floor(baseVolume * multiplier).toLocaleString();
            if (charts.priceTrend && MARKET_CHART_BASE && MARKET_CHART_BASE.priceTrend) {
                charts.priceTrend.data.datasets[0].data = MARKET_CHART_BASE.priceTrend[0].map(function(v) { return v * multiplier; });
                charts.priceTrend.data.datasets[1].data = MARKET_CHART_BASE.priceTrend[1].map(function(v) { return v * multiplier; });
                charts.priceTrend.update();
            }
            renderTopModels();
        }
        
        // ==========================================
        // Car Model Query Functions
        // ==========================================
        function quickSearch(query) {
            document.getElementById('carSearchInput').value = query;
            searchCarModel();
        }
        
        function searchCarModel() {
            const query = document.getElementById('carSearchInput').value.trim();
            if (!query) {
                showToast('è¯·è¾“å…¥è½¦å‹åç§°');
                return;
            }
            
            // Parse query to find car model and year
            let carKey = null;
            let year = '2023';
            
            // Check for car model
            for (const key in CAR_MODEL_DATABASE) {
                if (query.includes(key)) {
                    carKey = key;
                    break;
                }
            }
            
            // Check for year
            const yearMatch = query.match(/20\d{2}/);
            if (yearMatch) {
                year = yearMatch[0];
            }
            
            if (!carKey) {
                showToast('æœªæ‰¾åˆ°è¯¥è½¦å‹ï¼Œè¯•è¯•ï¼šè¿ˆè…¾ã€å‡¯ç¾ç‘ã€å®é©¬3ç³»ã€å¡ç½—æ‹‰ã€CR-V');
                return;
            }
            
            currentQueryCar = CAR_MODEL_DATABASE[carKey];
            currentQueryYear = year;
            
            // Show results
            document.getElementById('queryEmptyState').classList.add('hidden');
            document.getElementById('queryResults').classList.remove('hidden');
            
            // Update UI
            updateQueryCarInfo();
            renderQueryCharts();
            renderDealerTable();
            
            // Scroll to results
            document.getElementById('queryResults').scrollIntoView({ behavior: 'smooth' });
        }
        
        function updateQueryCarInfo() {
            const car = currentQueryCar;
            const yearData = car.years[currentQueryYear] || car.years['2023'];
            const rate = currentCountry.rate;
            const symbol = currentCountry.symbol;
            
            document.getElementById('queryCarName').textContent = `${car.brand} ${car.model}`;
            document.getElementById('queryCarYear').textContent = `${currentQueryYear}æ¬¾`;
            document.getElementById('queryCarSubtitle').textContent = `${car.category} | ${car.specs}`;
            
            // Convert prices to current country currency
            const newCarPriceLocal = Math.round(car.newCarPrice / rate);
            const avgPriceLocal = Math.round(yearData.avgPrice / rate);
            const minPriceLocal = Math.round(yearData.minPrice / rate);
            const maxPriceLocal = Math.round(yearData.maxPrice / rate);
            
            document.getElementById('queryCarPrice').textContent = `${symbol}${newCarPriceLocal.toLocaleString()}`;
            
            // Update KPI cards
            document.getElementById('kpiAvgPrice').textContent = `${symbol}${avgPriceLocal.toLocaleString()}`;
            document.getElementById('kpiPriceRange').textContent = `${symbol}${(minPriceLocal/1000).toFixed(0)}k - ${symbol}${(maxPriceLocal/1000).toFixed(0)}k`;
            document.getElementById('kpiRetention').textContent = `${yearData.retention}%`;
            document.getElementById('kpiVolume').textContent = yearData.volume.toLocaleString();
        }
        
        function changeTimeRange(range) {
            currentTimeRange = range;
            
            // Update button styles
            document.querySelectorAll('.time-range-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-500', 'text-white');
                btn.classList.add('bg-slate-100');
                if (btn.dataset.range === range) {
                    btn.classList.add('active', 'bg-blue-500', 'text-white');
                    btn.classList.remove('bg-slate-100');
                }
            });
            
            // Update chart
            renderPriceTrendChart();
        }
        
        function renderQueryCharts() {
            renderPriceTrendChart();
            renderPriceGaugeChart();
            renderRegionalPriceChart();
            renderCompetitorChart();
            renderMileagePriceChart();
            renderDepreciationForecastChart();
        }
        
        function renderPriceTrendChart() {
            const ctx = document.getElementById('queryPriceTrendChart');
            if (charts.queryPriceTrend) {
                charts.queryPriceTrend.destroy();
            }
            
            const priceData = currentQueryCar.priceHistory[currentTimeRange];
            let labels;
            if (currentTimeRange === '6m') {
                labels = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ'];
            } else if (currentTimeRange === '1y') {
                labels = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
            } else {
                labels = Array.from({length: 24}, (_, i) => `${i + 1}æœˆ`);
            }
            
            // Convert price data to current country currency
            const rate = currentCountry.rate;
            const symbol = currentCountry.symbol;
            const localPriceData = priceData.map(price => Math.round(price / rate));
            
            charts.queryPriceTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.slice(0, priceData.length),
                    datasets: [{
                        label: 'å¹³å‡æˆäº¤ä»·',
                        data: localPriceData,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointBackgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'å‡ä»·: ' + symbol + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return symbol + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderPriceGaugeChart() {
            const ctx = document.getElementById('priceGaugeChart');
            if (charts.priceGauge) {
                charts.priceGauge.destroy();
            }
            
            const yearData = currentQueryCar.years[currentQueryYear] || currentQueryCar.years['2023'];
            const avgPrice = yearData.avgPrice;
            const minPrice = yearData.minPrice;
            const maxPrice = yearData.maxPrice;
            const percentage = ((avgPrice - minPrice) / (maxPrice - minPrice)) * 100;
            
            charts.priceGauge = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['å½“å‰ä»·ä½', 'å‰©ä½™ç©ºé—´'],
                    datasets: [{
                        data: [percentage, 100 - percentage],
                        backgroundColor: ['#10b981', '#e2e8f0'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: {
                        legend: { display: false }
                    }
                },
                plugins: [{
                    id: 'gaugeText',
                    beforeDraw: function(chart) {
                        const ctx = chart.ctx;
                        ctx.save();
                        ctx.font = 'bold 24px Inter';
                        ctx.fillStyle = '#10b981';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(Math.round(percentage) + '%', chart.width / 2, chart.height / 2);
                        ctx.restore();
                    }
                }]
            });
        }
        
        function renderRegionalPriceChart() {
            const ctx = document.getElementById('regionalPriceChart');
            if (charts.regionalPrice) {
                charts.regionalPrice.destroy();
            }
            
            const yearData = currentQueryCar.years[currentQueryYear] || currentQueryCar.years['2023'];
            const basePrice = yearData.avgPrice;
            const rate = currentCountry.rate;
            const symbol = currentCountry.symbol;
            
            charts.regionalPrice = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['åŒ—äº¬', 'ä¸Šæµ·', 'å¹¿å·', 'æ·±åœ³', 'æˆéƒ½', 'æ­å·', 'æ­¦æ±‰', 'è¥¿å®‰'],
                    datasets: [{
                        label: 'å¹³å‡ä»·æ ¼',
                        data: [
                            Math.round(basePrice * 1.02 / rate),
                            Math.round(basePrice * 1.05 / rate),
                            Math.round(basePrice * 0.98 / rate),
                            Math.round(basePrice * 0.99 / rate),
                            Math.round(basePrice * 0.95 / rate),
                            Math.round(basePrice * 1.00 / rate),
                            Math.round(basePrice * 0.93 / rate),
                            Math.round(basePrice * 0.91 / rate)
                        ],
                        backgroundColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return symbol + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderCompetitorChart() {
            const ctx = document.getElementById('competitorChart');
            if (charts.competitor) {
                charts.competitor.destroy();
            }
            
            const competitors = currentQueryCar.competitors;
            const yearData = currentQueryCar.years[currentQueryYear] || currentQueryCar.years['2023'];
            
            const rate = currentCountry.rate;
            const symbol = currentCountry.symbol;
            
            charts.competitor = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [currentQueryCar.model, ...competitors.map(c => c.name)],
                    datasets: [{
                        label: 'å¹³å‡ä»·æ ¼',
                        data: [Math.round(yearData.avgPrice / rate), ...competitors.map(c => Math.round(c.avgPrice / rate))],
                        backgroundColor: ['#3b82f6', '#94a3b8', '#94a3b8', '#94a3b8', '#94a3b8']
                    }, {
                        label: 'ä¿å€¼ç‡',
                        data: [yearData.retention, ...competitors.map(c => c.retention)],
                        type: 'line',
                        borderColor: '#f59e0b',
                        backgroundColor: '#f59e0b',
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return symbol + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        },
                        y1: {
                            position: 'right',
                            min: 0,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderMileagePriceChart() {
            const ctx = document.getElementById('mileagePriceChart');
            if (charts.mileagePrice) {
                charts.mileagePrice.destroy();
            }
            
            const yearData = currentQueryCar.years[currentQueryYear] || currentQueryCar.years['2023'];
            const basePrice = yearData.avgPrice;
            const rate = currentCountry.rate;
            const symbol = currentCountry.symbol;
            
            // Generate scatter data
            const scatterData = [];
            for (let i = 0; i < 50; i++) {
                const mileage = Math.random() * 80000;
                const depreciation = 1 - (mileage / 200000);
                const priceVariation = 0.9 + Math.random() * 0.2;
                scatterData.push({
                    x: mileage,
                    y: Math.round(basePrice * depreciation * priceVariation / rate)
                });
            }
            
            charts.mileagePrice = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'è½¦æºåˆ†å¸ƒ',
                        data: scatterData,
                        backgroundColor: 'rgba(59, 130, 246, 0.5)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'é‡Œç¨‹ (km)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return (value / 10000) + 'ä¸‡';
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'ä»·æ ¼'
                            },
                            ticks: {
                                callback: function(value) {
                                    return symbol + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderDepreciationForecastChart() {
            const ctx = document.getElementById('depreciationForecastChart');
            if (charts.depreciationForecast) {
                charts.depreciationForecast.destroy();
            }
            
            const yearData = currentQueryCar.years[currentQueryYear] || currentQueryCar.years['2023'];
            const currentPrice = yearData.avgPrice;
            const rate = currentCountry.rate;
            const symbol = currentCountry.symbol;
            
            // Calculate depreciation for next 5 years
            const years = ['å½“å‰', '1å¹´å', '2å¹´å', '3å¹´å', '4å¹´å', '5å¹´å'];
            const values = [Math.round(currentPrice / rate)];
            let price = currentPrice;
            for (let i = 0; i < 5; i++) {
                price = price * 0.88; // 12% annual depreciation
                values.push(Math.round(price / rate));
            }
            
            charts.depreciationForecast = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'é¢„æµ‹æ®‹å€¼',
                        data: values,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return symbol + (value / 1000).toFixed(0) + 'k';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderDealerTable() {
            const tbody = document.getElementById('dealerTable');
            const yearData = currentQueryCar.years[currentQueryYear] || currentQueryCar.years['2023'];
            
            const cities = ['åŒ—äº¬', 'ä¸Šæµ·', 'å¹¿å·', 'æ·±åœ³', 'æˆéƒ½', 'æ­å·'];
            const conditions = ['excellent', 'good', 'good', 'excellent', 'fair', 'good'];
            const conditionLabels = {
                'excellent': { text: 'ä¼˜', class: 'condition-excellent' },
                'good': { text: 'è‰¯', class: 'condition-good' },
                'fair': { text: 'ä¸­', class: 'condition-fair' }
            };
            
            const rate = currentCountry.rate;
            const symbol = currentCountry.symbol;
            
            const dealers = cities.map((city, index) => {
                const priceVariation = 0.95 + Math.random() * 0.15;
                const mileage = Math.floor(10000 + Math.random() * 60000);
                const carAge = new Date().getFullYear() - parseInt(currentQueryYear);
                const price = Math.floor(yearData.avgPrice * priceVariation / rate);
                const condition = conditions[index];
                
                return {
                    city,
                    price,
                    mileage,
                    carAge,
                    condition
                };
            });
            
            // Sort by price ascending by default
            dealers.sort((a, b) => a.price - b.price);
            
            tbody.innerHTML = dealers.map(d => {
                const cond = conditionLabels[d.condition];
                return `
                    <tr class="dealer-row">
                        <td class="py-3">
                            <div class="flex items-center gap-2">
                                <div class="w-12 h-8 bg-slate-200 rounded"></div>
                                <div>
                                    <p class="font-medium">${currentQueryCar.brand} ${currentQueryCar.model}</p>
                                    <p class="text-xs text-slate-500">${currentQueryYear}æ¬¾ ${currentQueryCar.specs.split('|')[0]}</p>
                                </div>
                            </div>
                        </td>
                        <td class="py-3 text-right">
                            <p class="font-bold text-blue-600">${symbol}${d.price.toLocaleString()}</p>
                        </td>
                        <td class="py-3 text-right text-slate-600">${(d.mileage / 10000).toFixed(1)}ä¸‡å…¬é‡Œ</td>
                        <td class="py-3 text-right text-slate-600">${d.carAge}å¹´</td>
                        <td class="py-3">${d.city}</td>
                        <td class="py-3">
                            <span class="condition-badge ${cond.class}">${cond.text}</span>
                        </td>
                        <td class="py-3 text-right">
                            <button onclick="contactDealer('${d.city}')" class="px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg text-sm font-medium hover:bg-blue-100 transition-colors">
                                è”ç³»å–å®¶
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function sortDealerTable() {
            renderDealerTable();
        }
        
        function contactDealer(city) {
            showToast(`å·²è·å–${city}å–å®¶è”ç³»æ–¹å¼`);
        }
        
        // ==========================================
        // Vehicle Analysis
        // ==========================================
        function initYearSelect() {
            const select = document.getElementById('vYear');
            const currentYear = new Date().getFullYear();
            for (let year = currentYear; year >= currentYear - 20; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year + 'å¹´';
                select.appendChild(option);
            }
        }
        
        function analyzeVehicle() {
            const brand = document.getElementById('vBrand').value;
            const model = document.getElementById('vModel').value;
            const year = parseInt(document.getElementById('vYear').value);
            const mileage = parseInt(document.getElementById('vMileage').value) || 0;
            const newPrice = parseFloat(document.getElementById('vNewPrice').value) || 0;
            const price = parseFloat(document.getElementById('vPrice').value) || 0;
            
            if (!brand || !model || !year) {
                showToast('è¯·å¡«å†™å®Œæ•´çš„è½¦è¾†ä¿¡æ¯');
                return;
            }
            
            // Calculate scores
            const age = new Date().getFullYear() - year;
            const ageScore = Math.max(0, 100 - age * 8);
            const mileageScore = Math.max(0, 100 - (mileage / 10000) * 5);
            const valueScore = newPrice > 0 ? Math.min(100, (newPrice / price) * 50) : 70;
            const demandScore = Math.floor(Math.random() * 20) + 75; // Simulated
            
            const totalScore = Math.floor((ageScore + mileageScore + valueScore + demandScore) / 4);
            
            // Update UI
            document.getElementById('totalScore').textContent = totalScore;
            document.getElementById('scoreBar').style.width = totalScore + '%';
            document.getElementById('scoreValue').textContent = Math.floor(valueScore);
            document.getElementById('scoreCondition').textContent = Math.floor((ageScore + mileageScore) / 2);
            document.getElementById('scoreRetention').textContent = Math.floor(100 - age * 3);
            document.getElementById('scoreDemand').textContent = demandScore;
            
            // Show results
            document.getElementById('vehicleResults').classList.remove('hidden');
            
            // Create radar chart
            const radarCtx = document.getElementById('vehicleRadarChart');
            if (charts.vehicleRadar) charts.vehicleRadar.destroy();
            charts.vehicleRadar = new Chart(radarCtx, {
                type: 'radar',
                data: {
                    labels: ['æ€§ä»·æ¯”', 'è½¦å†µ', 'ä¿å€¼ç‡', 'å¸‚åœºéœ€æ±‚', 'é…ç½®æ°´å¹³'],
                    datasets: [{
                        label: 'è¯„åˆ†',
                        data: [valueScore, (ageScore + mileageScore) / 2, 100 - age * 3, demandScore, 80],
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: '#3b82f6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { r: { min: 0, max: 100 } }
                }
            });
            
            // Create depreciation chart
            const deprCtx = document.getElementById('depreciationChart');
            if (charts.depreciation) charts.depreciation.destroy();
            const years = [0, 1, 2, 3, 4, 5];
            const values = years.map(y => newPrice * Math.pow(0.85, y + age));
            charts.depreciation = new Chart(deprCtx, {
                type: 'line',
                data: {
                    labels: years.map(y => (new Date().getFullYear() + y) + 'å¹´'),
                    datasets: [{
                        label: 'é¢„æµ‹æ®‹å€¼',
                        data: values,
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
            
            // Generate recommendation
            generateRecommendation(totalScore, valueScore, age);
            
            // Scroll to results
            document.getElementById('vehicleResults').scrollIntoView({ behavior: 'smooth' });
        }
        
        function generateRecommendation(totalScore, valueScore, age) {
            let text = '';
            if (totalScore >= 85) {
                text = 'ğŸŸ¢ å¼ºçƒˆæ¨èï¼šè¯¥è½¦è¾†ç»¼åˆè¯„åˆ†ä¼˜ç§€ï¼Œæ€§ä»·æ¯”è¾ƒé«˜ï¼Œå»ºè®®ä¼˜å…ˆè€ƒè™‘è´­ä¹°ã€‚';
            } else if (totalScore >= 70) {
                text = 'ğŸŸ¡ å¯ä»¥è€ƒè™‘ï¼šè½¦è¾†æ•´ä½“çŠ¶å†µè‰¯å¥½ï¼Œå»ºè®®å®åœ°çœ‹è½¦åå†³å®šï¼Œæ³¨æ„æ ¸å®ä¿å…»è®°å½•ã€‚';
            } else {
                text = 'ğŸ”´ è°¨æ…è€ƒè™‘ï¼šè½¦è¾†è¯„åˆ†åä½ï¼Œå¯èƒ½å­˜åœ¨ä¸€å®šçš„ä½¿ç”¨é£é™©ï¼Œå»ºè®®ä»”ç»†è¯„ä¼°æˆ–å¯»æ‰¾å…¶ä»–è½¦æºã€‚';
            }
            
            text += `<br><br>å…·ä½“å»ºè®®ï¼š<br>`;
            if (valueScore > 80) {
                text += `â€¢ è¯¥è½¦ä»·æ ¼ç›¸å¯¹åˆç†ï¼Œæœ‰ä¸€å®šçš„è®®ä»·ç©ºé—´<br>`;
            }
            if (age > 8) {
                text += `â€¢ è½¦é¾„è¾ƒé•¿ï¼Œå»ºè®®é‡ç‚¹æ£€æŸ¥å‘åŠ¨æœºå’Œå˜é€Ÿç®±çŠ¶å†µ<br>`;
            }
            text += `â€¢ å»ºè®®æŸ¥è¯¢4Såº—ä¿å…»è®°å½•å’Œä¿é™©ç†èµ”è®°å½•<br>`;
            text += `â€¢ äº¤æ˜“å‰å»ºè®®è¿›è¡Œç¬¬ä¸‰æ–¹æ£€æµ‹`;
            
            document.getElementById('recommendationText').innerHTML = text;
        }
        
        // ==========================================
        // Calculator Functions
        // ==========================================
        // Database Functions
        // ==========================================
        function loadSavedVehicles() {
            const saved = localStorage.getItem('aseanUsedCarRecords');
            if (saved) {
                savedVehicles = JSON.parse(saved);
            }
            
            const container = document.getElementById('savedVehiclesList');
            const emptyState = document.getElementById('emptyState');
            
            if (savedVehicles.length === 0) {
                container.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            container.innerHTML = savedVehicles.map(v => `
                <div class="vehicle-item flex items-center justify-between p-4 bg-slate-50 rounded-xl">
                    <div>
                        <p class="font-medium">${v.brand} ${v.model}</p>
                        <p class="text-xs text-slate-500">${v.year}å¹´ Â· ${v.date}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-blue-500">${v.value} ${v.currency}</p>
                        <button onclick="deleteRecord(${v.id})" class="text-xs text-red-500 mt-1">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }
        
        function deleteRecord(id) {
            savedVehicles = savedVehicles.filter(v => v.id !== id);
            localStorage.setItem('aseanUsedCarRecords', JSON.stringify(savedVehicles));
            loadSavedVehicles();
            showToast('å·²åˆ é™¤');
        }
        
        function exportDatabase() {
            const data = {
                exportTime: new Date().toISOString(),
                country: currentCountry,
                records: savedVehicles
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `asean-used-car-backup-${new Date().toLocaleDateString('zh-CN')}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('å¯¼å‡ºæˆåŠŸ');
        }
        
        // ==========================================
        // Utility Functions
        // ==========================================
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }
    </script>
    
    <!-- ==========================================
         Floating Calculator Widget (å³ä¸‹è§’æ‚¬æµ®è®¡ç®—å™¨)
         ========================================== -->
    
    <!-- Floating Toggle Button -->
    <button id="calcToggleBtn" onclick="toggleCalculator()" 
            class="fixed bottom-6 right-6 z-50 w-14 h-14 rounded-full bg-gradient-to-r from-blue-500 to-blue-600 text-white shadow-lg shadow-blue-500/30 flex items-center justify-center transition-all duration-300 hover:scale-110 hover:shadow-xl"
            title="è½¦è¾†è¯„ä¼°è®¡ç®—å™¨">
        <!-- Calculator Icon SVG -->
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
            <rect x="4" y="2" width="16" height="20" rx="2"></rect>
            <line x1="8" x2="16" y1="6" y2="6"></line>
            <line x1="16" x2="16" y1="14" y2="18"></line>
            <path d="M16 10h.01"></path>
            <path d="M12 10h.01"></path>
            <path d="M8 10h.01"></path>
            <path d="M12 14h.01"></path>
            <path d="M8 14h.01"></path>
            <path d="M12 18h.01"></path>
            <path d="M8 18h.01"></path>
        </svg>
    </button>
    
    <!-- Calculator Widget Window -->
    <div id="calcWidget" class="fixed bottom-24 right-6 z-50 w-[400px] max-w-[calc(100vw-48px)] bg-white rounded-2xl shadow-2xl transform transition-all duration-300 origin-bottom-right scale-0 opacity-0 pointer-events-none">
        <!-- Widget Header -->
        <div class="flex items-center justify-between p-4 border-b border-slate-100 bg-gradient-to-r from-slate-50 to-white rounded-t-2xl">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-lg bg-blue-500 flex items-center justify-center text-white">
                    <!-- Calculator Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="4" y="2" width="16" height="20" rx="2"></rect>
                        <line x1="8" x2="16" y1="6" y2="6"></line>
                        <line x1="16" x2="16" y1="14" y2="18"></line>
                        <path d="M16 10h.01"></path>
                        <path d="M12 10h.01"></path>
                        <path d="M8 10h.01"></path>
                        <path d="M12 14h.01"></path>
                        <path d="M8 14h.01"></path>
                        <path d="M12 18h.01"></path>
                        <path d="M8 18h.01"></path>
                    </svg>
                </div>
                <span class="font-semibold text-slate-800">è½¦è¾†è¯„ä¼°</span>
            </div>
            <div class="flex items-center gap-1">
                <button onclick="minimizeCalculator()" class="p-1.5 hover:bg-slate-100 rounded-lg transition-colors" title="æœ€å°åŒ–">
                    <!-- Minus Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-400">
                        <path d="M5 12h14"></path>
                    </svg>
                </button>
                <button onclick="toggleCalculator()" class="p-1.5 hover:bg-slate-100 rounded-lg transition-colors" title="å…³é—­">
                    <!-- X Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-400">
                        <path d="M18 6 6 18"></path>
                        <path d="m6 6 12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Widget Body (Scrollable) -->
        <div class="max-h-[70vh] overflow-y-auto p-4">
            <!-- Quick Result Card (Always Visible) -->
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-xl p-4 text-white mb-4">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-blue-100 text-sm">è¯„ä¼°ä»·å€¼</span>
                    <button onclick="resetCalculator()" class="text-xs text-blue-100 hover:text-white transition-colors">
                        é‡ç½®
                    </button>
                </div>
                <div class="flex items-baseline gap-2">
                    <span class="text-3xl font-bold" id="widgetCalcResult">0.00</span>
                    <span class="text-lg" id="widgetCurrency"></span>
                </div>
                <p class="text-blue-100 text-sm mt-1" id="widgetCalcResultCNY">â‰ˆ Â¥0.00</p>
            </div>
            
            <!-- Collapsible Sections -->
            <div class="space-y-3">
                <!-- Basic Info Section -->
                <div class="border border-slate-100 rounded-xl overflow-hidden">
                    <button onclick="toggleSection('basicInfo')" class="w-full flex items-center justify-between p-3 bg-slate-50 hover:bg-slate-100 transition-colors">
                        <span class="font-medium text-sm text-slate-700">åŸºç¡€ä¿¡æ¯</span>
                        <svg id="icon-basicInfo" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-400 transition-transform">
                            <path d="m6 9 6 6 6-6"></path>
                        </svg>
                    </button>
                    <div id="section-basicInfo" class="p-3 space-y-3">
                        <div>
                            <label class="block text-xs font-medium text-slate-500 mb-1.5">æ–°è½¦è´­ç½®ä»· (<span class="currency-label"></span>ä¸‡)</label>
                            <input type="number" id="widgetCalcPrice" step="0.01" 
                                   class="input-field w-full px-3 py-2 rounded-lg border border-slate-200 text-sm" 
                                   placeholder="0.00" oninput="widgetCalculate()">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs font-medium text-slate-500 mb-1.5">è´­ç½®ç¨</label>
                                <input type="number" id="widgetCalcTax" step="0.01" 
                                       class="input-field w-full px-3 py-2 rounded-lg border border-slate-200 text-sm" 
                                       placeholder="è‡ªåŠ¨" oninput="widgetCalculate()">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-500 mb-1.5">å…¶ä»–è´¹ç”¨</label>
                                <input type="number" id="widgetCalcOther" step="0.01" 
                                       class="input-field w-full px-3 py-2 rounded-lg border border-slate-200 text-sm" 
                                       placeholder="0.00" oninput="widgetCalculate()">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Usage Section -->
                <div class="border border-slate-100 rounded-xl overflow-hidden">
                    <button onclick="toggleSection('usage')" class="w-full flex items-center justify-between p-3 bg-slate-50 hover:bg-slate-100 transition-colors">
                        <span class="font-medium text-sm text-slate-700">ä½¿ç”¨æƒ…å†µ</span>
                        <svg id="icon-usage" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-400 transition-transform">
                            <path d="m6 9 6 6 6-6"></path>
                        </svg>
                    </button>
                    <div id="section-usage" class="p-3 space-y-3 hidden">
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs font-medium text-slate-500 mb-1.5">å·²ç”¨å¹´é™</label>
                                <input type="number" id="widgetCalcUsedYears" step="0.1" 
                                       class="input-field w-full px-3 py-2 rounded-lg border border-slate-200 text-sm" 
                                       placeholder="0.0" oninput="widgetCalculate()">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-500 mb-1.5">è§„å®šå¹´é™</label>
                                <input type="number" id="widgetCalcTotalYears" value="15" 
                                       class="input-field w-full px-3 py-2 rounded-lg border border-slate-200 text-sm" 
                                       oninput="widgetCalculate()">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs font-medium text-slate-500 mb-1.5">å·²è¡Œé©¶é‡Œç¨‹(km)</label>
                                <input type="number" id="widgetCalcMileage" step="1000" 
                                       class="input-field w-full px-3 py-2 rounded-lg border border-slate-200 text-sm" 
                                       placeholder="0" oninput="widgetCalculate()">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-slate-500 mb-1.5">è§„å®šé‡Œç¨‹(km)</label>
                                <input type="number" id="widgetCalcTotalMileage" value="600000" 
                                       class="input-field w-full px-3 py-2 rounded-lg border border-slate-200 text-sm" 
                                       oninput="widgetCalculate()">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Coefficients Section -->
                <div class="border border-slate-100 rounded-xl overflow-hidden">
                    <button onclick="toggleSection('coefficients')" class="w-full flex items-center justify-between p-3 bg-slate-50 hover:bg-slate-100 transition-colors">
                        <span class="font-medium text-sm text-slate-700">è°ƒæ•´ç³»æ•° <span class="text-xs text-slate-400">(0-1)</span></span>
                        <svg id="icon-coefficients" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-400 transition-transform">
                            <path d="m6 9 6 6 6-6"></path>
                        </svg>
                    </button>
                    <div id="section-coefficients" class="p-3 space-y-2 hidden">
                        <div class="space-y-2" id="widgetCoefficientsContainer">
                            <!-- Coefficient inputs will be generated here -->
                        </div>
                    </div>
                </div>
                
                <!-- Details Section -->
                <div class="border border-slate-100 rounded-xl overflow-hidden">
                    <button onclick="toggleSection('details')" class="w-full flex items-center justify-between p-3 bg-slate-50 hover:bg-slate-100 transition-colors">
                        <span class="font-medium text-sm text-slate-700">è®¡ç®—æ˜ç»†</span>
                        <svg id="icon-details" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-400 transition-transform">
                            <path d="m6 9 6 6 6-6"></path>
                        </svg>
                    </button>
                    <div id="section-details" class="p-3 hidden">
                        <div class="grid grid-cols-3 gap-2 text-center text-xs">
                            <div class="bg-slate-50 rounded-lg p-2">
                                <p class="text-slate-500 mb-1">é‡ç½®æˆæœ¬</p>
                                <p class="font-semibold text-slate-800" id="widgetCalcResetCost">0.00</p>
                            </div>
                            <div class="bg-slate-50 rounded-lg p-2">
                                <p class="text-slate-500 mb-1">æˆæ–°ç‡</p>
                                <p class="font-semibold text-slate-800" id="widgetCalcNewRate">0%</p>
                            </div>
                            <div class="bg-slate-50 rounded-lg p-2">
                                <p class="text-slate-500 mb-1">ç»¼åˆç³»æ•°</p>
                                <p class="font-semibold text-slate-800" id="widgetCalcCoef">0.000</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Save Button -->
            <button onclick="saveWidgetCalculation()" class="btn-primary w-full mt-4 py-2.5 rounded-xl text-white font-medium text-sm">
                ä¿å­˜è¯„ä¼°è®°å½•
            </button>
        </div>
    </div>
    
    <!-- Calculator Widget Styles -->
    <style>
        /* Floating Calculator Widget Styles */
        #calcWidget {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25), 0 0 0 1px rgba(0, 0, 0, 0.05);
        }
        
        #calcWidget.open {
            transform: scale(1);
            opacity: 1;
            pointer-events: auto;
        }
        
        #calcWidget.minimized {
            height: 60px;
            overflow: hidden;
        }
        
        #calcWidget.minimized .maximize-btn {
            display: block;
        }
        
        #calcToggleBtn {
            animation: pulse 2s infinite;
        }
        
        #calcToggleBtn:hover {
            animation: none;
        }
        
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.4);
            }
            50% {
                box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.6), 0 0 0 10px rgba(59, 130, 246, 0.1);
            }
        }
        
        .widget-section-content {
            transition: all 0.2s ease;
        }
        
        /* Mobile Responsive */
        @media (max-width: 640px) {
            #calcWidget {
                width: calc(100vw - 48px);
                right: 24px;
                left: 24px;
            }
        }
    </style>
    
    <!-- Calculator Widget JavaScript -->
    <script>
        // Re-initialize Lucide icons for dynamically added elements
        function refreshIcons() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }
        
        // Initialize widget coefficients
        function initWidgetCoefficients() {
            const coefficients = [
                { id: 'widgetTechStatus', name: 'è½¦å†µæŠ€æœ¯çŠ¶å†µ', max: 1 },
                { id: 'widgetMaintenance', name: 'ç»´æŠ¤ä¿å…»', max: 1 },
                { id: 'widgetReputation', name: 'å“ç‰Œè½¦å‹å£ç¢‘', max: 1 },
                { id: 'widgetUsageType', name: 'è½¦è¾†ç”¨é€”', max: 1 },
                { id: 'widgetEnvironment', name: 'å·¥ä½œç¯å¢ƒ', max: 1 },
                { id: 'widgetConfig', name: 'é…ç½®ä¸é¢œè‰²', max: 1 },
                { id: 'widgetBattery', name: 'ç”µæ± å¥åº·ç¨‹åº¦', max: 1 },
                { id: 'widgetPowerSystem', name: 'ä¸‰ç”µç³»ç»ŸçŠ¶æ€', max: 1 },
            ];
            
            const container = document.getElementById('widgetCoefficientsContainer');
            container.innerHTML = coefficients.map(coef => `
                <div class="flex items-center justify-between">
                    <label class="text-xs text-slate-600">${coef.name}</label>
                    <div class="flex items-center gap-2">
                        <input type="range" id="${coef.id}" min="0" max="${coef.max}" step="0.01" value="1"
                               class="range-slider w-20 h-1.5" oninput="widgetUpdateCoefDisplay('${coef.id}'); widgetCalculate()">
                        <span class="text-xs font-medium text-blue-500 w-8 text-right" id="${coef.id}Value">1.00</span>
                    </div>
                </div>
            `).join('');
        }
        
        function widgetUpdateCoefDisplay(id) {
            const val = document.getElementById(id).value;
            document.getElementById(id + 'Value').textContent = parseFloat(val).toFixed(2);
        }
        
        // Auto-calculate tax in widget
        document.getElementById('widgetCalcPrice').addEventListener('input', function() {
            const price = parseFloat(this.value) || 0;
            document.getElementById('widgetCalcTax').value = (price / 11.3).toFixed(2);
            widgetCalculate();
        });
        
        function widgetCalculate() {
            const price = parseFloat(document.getElementById('widgetCalcPrice').value) || 0;
            const tax = parseFloat(document.getElementById('widgetCalcTax').value) || 0;
            const other = parseFloat(document.getElementById('widgetCalcOther').value) || 0;
            const usedYears = parseFloat(document.getElementById('widgetCalcUsedYears').value) || 0;
            const totalYears = parseFloat(document.getElementById('widgetCalcTotalYears').value) || 15;
            const mileage = parseFloat(document.getElementById('widgetCalcMileage').value) || 0;
            const totalMileage = parseFloat(document.getElementById('widgetCalcTotalMileage').value) || 600000;
            
            // Get coefficients
            const coefs = ['widgetTechStatus', 'widgetMaintenance', 'widgetReputation', 'widgetUsageType', 
                          'widgetEnvironment', 'widgetConfig', 'widgetBattery', 'widgetPowerSystem'];
            let adjustCoef = 1;
            coefs.forEach(id => {
                adjustCoef *= parseFloat(document.getElementById(id)?.value || 0) || 1;
            });
            
            // Calculate
            const resetCost = price + tax + other;
            const yearRate = Math.max(0, (1 - usedYears / totalYears) * 100);
            const mileageRate = Math.max(0, (1 - mileage / totalMileage) * 100);
            const conditionRate = (yearRate * mileageRate) / 100;
            const finalRate = conditionRate * adjustCoef;
            const finalValue = resetCost * (finalRate / 100);
            
            // Update display
            document.getElementById('widgetCalcResult').textContent = finalValue.toFixed(2);
            document.getElementById('widgetCalcResultCNY').textContent = `â‰ˆ Â¥${(finalValue * currentCountry.rate).toFixed(2)}`;
            document.getElementById('widgetCalcResetCost').textContent = resetCost.toFixed(2);
            document.getElementById('widgetCalcNewRate').textContent = finalRate.toFixed(1) + '%';
            document.getElementById('widgetCalcCoef').textContent = adjustCoef.toFixed(4);
        }
        
        function toggleCalculator() {
            const widget = document.getElementById('calcWidget');
            const isOpen = widget.classList.contains('open');
            
            if (isOpen) {
                widget.classList.remove('open');
                setTimeout(() => {
                    widget.style.display = 'none';
                }, 300);
            } else {
                widget.style.display = 'block';
                setTimeout(() => {
                    widget.classList.add('open');
                    refreshIcons(); // Refresh icons when widget opens
                }, 10);
            }
        }
        
        function minimizeCalculator() {
            const widget = document.getElementById('calcWidget');
            widget.classList.remove('open');
            setTimeout(() => {
                widget.style.display = 'none';
            }, 300);
        }
        
        function toggleSection(sectionId) {
            const section = document.getElementById('section-' + sectionId);
            const icon = document.getElementById('icon-' + sectionId);
            
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
            } else {
                section.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        }
        
        function resetCalculator() {
            document.getElementById('widgetCalcPrice').value = '';
            document.getElementById('widgetCalcTax').value = '';
            document.getElementById('widgetCalcOther').value = '';
            document.getElementById('widgetCalcUsedYears').value = '';
            document.getElementById('widgetCalcMileage').value = '';
            
            // Reset coefficients
            const coefs = ['widgetTechStatus', 'widgetMaintenance', 'widgetReputation', 'widgetUsageType', 
                          'widgetEnvironment', 'widgetConfig', 'widgetBattery', 'widgetPowerSystem'];
            coefs.forEach(id => {
                const slider = document.getElementById(id);
                if (slider) {
                    slider.value = 1;
                    document.getElementById(id + 'Value').textContent = '1.00';
                }
            });
            
            widgetCalculate();
            showToast('å·²é‡ç½®');
        }
        
        function saveWidgetCalculation() {
            const record = {
                id: Date.now(),
                date: new Date().toLocaleString('zh-CN'),
                brand: 'è¯„ä¼°è½¦è¾†',
                model: document.getElementById('widgetCalcPrice').value ? 'ä»·æ ¼:' + document.getElementById('widgetCalcPrice').value + 'ä¸‡' : 'æœªå‘½å',
                year: new Date().getFullYear(),
                value: document.getElementById('widgetCalcResult').textContent,
                currency: currentCountry.currency
            };
            
            savedVehicles.push(record);
            localStorage.setItem('aseanUsedCarRecords', JSON.stringify(savedVehicles));
            showToast('ä¿å­˜æˆåŠŸ');
        }
        
        // Initialize widget on load
        document.addEventListener('DOMContentLoaded', function() {
            initWidgetCoefficients();
            document.getElementById('calcWidget').style.display = 'none';
        });
    </script>
</body>
</html>
