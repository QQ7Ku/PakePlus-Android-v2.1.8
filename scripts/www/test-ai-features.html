<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIåŠŸèƒ½æµ‹è¯• - ASEAN NEV Platform</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 30px; color: #1e293b; }
        .test-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; }
        .test-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .test-card h3 {
            font-size: 16px;
            color: #334155;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        .test-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f1f5f9;
        }
        .test-item:last-child { border-bottom: none; }
        .test-status {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }
        .test-status.pass { background: #dcfce7; color: #166534; }
        .test-status.fail { background: #fee2e2; color: #991b1b; }
        .test-status.pending { background: #fef3c7; color: #92400e; }
        .test-name { flex: 1; font-size: 14px; color: #475569; }
        .test-detail {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 4px;
        }
        .summary {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }
        .summary-score {
            font-size: 48px;
            font-weight: bold;
            color: #0d9488;
        }
        .summary-text { color: #64748b; margin-top: 8px; }
        .run-btn {
            background: linear-gradient(135deg, #14b8a6, #0d9488);
            color: white;
            border: none;
            padding: 12px 32px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 20px auto;
            display: block;
        }
        .run-btn:hover { opacity: 0.9; }
        .console-output {
            background: #1e293b;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .console-line { margin: 2px 0; }
        .console-info { color: #38bdf8; }
        .console-success { color: #4ade80; }
        .console-error { color: #f87171; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– AIåŠŸèƒ½æµ‹è¯•é¢æ¿</h1>
        <button class="run-btn" onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        
        <div class="test-grid">
            <div class="test-card">
                <h3>ğŸ“Š ä¼°å€¼å¼•æ“ (ValuationEngine)</h3>
                <div id="valuation-tests"></div>
            </div>
            <div class="test-card">
                <h3>ğŸ“ˆ å¸‚åœºé¢„æµ‹ (MarketPredictor)</h3>
                <div id="predictor-tests"></div>
            </div>
            <div class="test-card">
                <h3>ğŸ—„ï¸ æ•°æ®ç®¡ç† (DataManager)</h3>
                <div id="datamanager-tests"></div>
            </div>
            <div class="test-card">
                <h3>ğŸ” æœç´¢å¼•æ“ (MarketSearchEngine)</h3>
                <div id="searchengine-tests"></div>
            </div>
        </div>
        
        <div class="summary">
            <div class="summary-score" id="total-score">--</div>
            <div class="summary-text">ç»¼åˆè¯„åˆ† / 100</div>
        </div>
        
        <div class="console-output" id="console"></div>
    </div>

    <script type="module">
        import { AIValuationEngine } from './js/modules/aiValuationEngine.js';
        import { AIMarketPredictor } from './js/modules/aiMarketPredictor.js';
        import { DataManager } from './js/modules/dataManager.js';
        import { MarketSearchEngine } from './js/modules/marketSearchEngine.js';

        const consoleEl = document.getElementById('console');
        
        function log(msg, type = 'info') {
            const line = document.createElement('div');
            line.className = `console-line console-${type}`;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            consoleEl.appendChild(line);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        function createTestItem(name, status, detail = '') {
            const statusClass = status === 'pass' ? 'pass' : status === 'fail' ? 'fail' : 'pending';
            const icon = status === 'pass' ? 'âœ“' : status === 'fail' ? 'âœ—' : 'â—‹';
            return `
                <div class="test-item">
                    <div class="test-status ${statusClass}">${icon}</div>
                    <div>
                        <div class="test-name">${name}</div>
                        ${detail ? `<div class="test-detail">${detail}</div>` : ''}
                    </div>
                </div>
            `;
        }

        // æµ‹è¯•ç»“æœå­˜å‚¨
        const testResults = {
            valuation: [],
            predictor: [],
            datamanager: [],
            searchengine: []
        };

        // ========== ä¼°å€¼å¼•æ“æµ‹è¯• ==========
        async function testValuationEngine() {
            log('å¼€å§‹æµ‹è¯• ValuationEngine...', 'info');
            const results = [];
            
            try {
                // æµ‹è¯•1: ä¾èµ–æ³¨å…¥
                const mockRandom = () => 0.5;
                const mockTime = { now: () => 1700000000000 };
                const engine = new AIValuationEngine({
                    randomGenerator: mockRandom,
                    timeProvider: mockTime,
                    delay: 0
                });
                results.push({ name: 'ä¾èµ–æ³¨å…¥æ”¯æŒ', status: 'pass', detail: 'randomGenerator/timeProvider/delay' });
                
                // æµ‹è¯•2: åŸºç¡€è®¡ç®—
                const result = await engine.calculate('byd-qin-plus', 'th', 2022, 50000);
                const hasResult = result && result.estimatedPrice > 0;
                results.push({ name: 'åŸºç¡€ä¼°å€¼è®¡ç®—', status: hasResult ? 'pass' : 'fail', detail: hasResult ? `ä»·æ ¼: ${result.estimatedPrice}` : 'æ— ç»“æœ' });
                
                // æµ‹è¯•3: å‚æ•°éªŒè¯
                try {
                    await engine.calculate('', 'th', 2022, 50000);
                    results.push({ name: 'å‚æ•°éªŒè¯', status: 'fail', detail: 'åº”è¯¥æŠ›å‡ºé”™è¯¯' });
                } catch (e) {
                    results.push({ name: 'å‚æ•°éªŒè¯', status: 'pass', detail: 'æ­£ç¡®æ‹’ç»æ— æ•ˆå‚æ•°' });
                }
                
                // æµ‹è¯•4: ç”µæ± æŠ˜æ—§è®¡ç®—
                const batteryResult = engine.calculateBatteryDepreciation(90, 100000);
                const hasBattery = batteryResult && typeof batteryResult.healthScore === 'number';
                results.push({ name: 'ç”µæ± æŠ˜æ—§è®¡ç®—', status: hasBattery ? 'pass' : 'fail' });
                
                log('ValuationEngine æµ‹è¯•å®Œæˆ', 'success');
            } catch (e) {
                log(`ValuationEngine é”™è¯¯: ${e.message}`, 'error');
                results.push({ name: 'æ•´ä½“æµ‹è¯•', status: 'fail', detail: e.message });
            }
            
            testResults.valuation = results;
            return results;
        }

        // ========== å¸‚åœºé¢„æµ‹æµ‹è¯• ==========
        async function testMarketPredictor() {
            log('å¼€å§‹æµ‹è¯• MarketPredictor...', 'info');
            const results = [];
            
            try {
                // æµ‹è¯•1: ä¾èµ–æ³¨å…¥
                const mockRandom = () => 0.5;
                const predictor = new AIMarketPredictor({
                    randomGenerator: mockRandom,
                    delay: 0
                });
                results.push({ name: 'ä¾èµ–æ³¨å…¥æ”¯æŒ', status: 'pass' });
                
                // æµ‹è¯•2: é¢„æµ‹ç”Ÿæˆ
                const prediction = await predictor.predict('byd-qin-plus', 'th', 3);
                const hasPrediction = prediction && prediction.priceForecast && prediction.priceForecast.length === 3;
                results.push({ name: 'é¢„æµ‹ç”Ÿæˆ', status: hasPrediction ? 'pass' : 'fail', detail: hasPrediction ? `${prediction.priceForecast.length}ä¸ªæœˆé¢„æµ‹` : 'æ— ç»“æœ' });
                
                // æµ‹è¯•3: å‚æ•°éªŒè¯
                try {
                    await predictor.predict('', 'th');
                    results.push({ name: 'å‚æ•°éªŒè¯', status: 'fail', detail: 'åº”è¯¥æŠ›å‡ºé”™è¯¯' });
                } catch (e) {
                    results.push({ name: 'å‚æ•°éªŒè¯', status: 'pass', detail: 'æ­£ç¡®æ‹’ç»ç©ºmodelId' });
                }
                
                log('MarketPredictor æµ‹è¯•å®Œæˆ', 'success');
            } catch (e) {
                log(`MarketPredictor é”™è¯¯: ${e.message}`, 'error');
                results.push({ name: 'æ•´ä½“æµ‹è¯•', status: 'fail', detail: e.message });
            }
            
            testResults.predictor = results;
            return results;
        }

        // ========== æ•°æ®ç®¡ç†å™¨æµ‹è¯• ==========
        async function testDataManager() {
            log('å¼€å§‹æµ‹è¯• DataManager...', 'info');
            const results = [];
            
            try {
                // æµ‹è¯•1: ä¾èµ–æ³¨å…¥
                const mockRandom = () => 0.5;
                const dm = new DataManager({
                    randomGenerator: mockRandom,
                    delay: 0
                });
                results.push({ name: 'ä¾èµ–æ³¨å…¥æ”¯æŒ', status: 'pass' });
                
                // æµ‹è¯•2: åŸºç¡€æ•°æ®è·å–
                const countries = dm.getCountries?.() || dm.countries;
                const hasCountries = Array.isArray(countries) && countries.length > 0;
                results.push({ name: 'å›½å®¶æ•°æ®', status: hasCountries ? 'pass' : 'fail', detail: hasCountries ? `${countries.length}ä¸ªå›½å®¶` : 'æ— æ•°æ®' });
                
                // æµ‹è¯•3: è½¦å‹æ•°æ®
                const models = dm.getModels?.() || dm.models;
                const hasModels = Array.isArray(models) && models.length > 0;
                results.push({ name: 'è½¦å‹æ•°æ®', status: hasModels ? 'pass' : 'fail', detail: hasModels ? `${models.length}ä¸ªè½¦å‹` : 'æ— æ•°æ®' });
                
                // æµ‹è¯•4: è¶‹åŠ¿æ•°æ®ç”Ÿæˆ
                const trend = dm.generateDefaultTrend?.(1000000, 7);
                const hasTrend = Array.isArray(trend) && trend.length > 0;
                results.push({ name: 'è¶‹åŠ¿æ•°æ®ç”Ÿæˆ', status: hasTrend ? 'pass' : 'fail', detail: hasTrend ? `${trend.length}ä¸ªæ•°æ®ç‚¹` : 'æ— æ•°æ®' });
                
                log('DataManager æµ‹è¯•å®Œæˆ', 'success');
            } catch (e) {
                log(`DataManager é”™è¯¯: ${e.message}`, 'error');
                results.push({ name: 'æ•´ä½“æµ‹è¯•', status: 'fail', detail: e.message });
            }
            
            testResults.datamanager = results;
            return results;
        }

        // ========== æœç´¢å¼•æ“æµ‹è¯• ==========
        async function testSearchEngine() {
            log('å¼€å§‹æµ‹è¯• MarketSearchEngine...', 'info');
            const results = [];
            
            try {
                // æµ‹è¯•1: ä¾èµ–æ³¨å…¥
                const mockRandom = () => 0.5;
                const engine = new MarketSearchEngine({
                    randomGenerator: mockRandom,
                    delay: 0
                });
                results.push({ name: 'ä¾èµ–æ³¨å…¥æ”¯æŒ', status: 'pass' });
                
                // æµ‹è¯•2: æœç´¢åŠŸèƒ½
                const searchResult = await engine.search({ brand: 'byd', model: 'qin-plus', country: 'th' });
                const hasResult = searchResult && searchResult.monthlyData && searchResult.monthlyData.length > 0;
                results.push({ name: 'æœç´¢åŠŸèƒ½', status: hasResult ? 'pass' : 'fail', detail: hasResult ? `${searchResult.monthlyData.length}ä¸ªæœˆæ•°æ®` : 'æ— ç»“æœ' });
                
                // æµ‹è¯•3: è¿‘æœŸæˆäº¤æ•°æ®
                const recentDeals = engine.generateRecentDeals?.('byd', 'qin-plus', 'th', 7);
                const hasDeals = recentDeals && recentDeals.deals && recentDeals.deals.length > 0;
                results.push({ name: 'è¿‘æœŸæˆäº¤æ•°æ®', status: hasDeals ? 'pass' : 'fail', detail: hasDeals ? `${recentDeals.totalCount}æ¡æˆäº¤` : 'æ— æ•°æ®' });
                
                // æµ‹è¯•4: ä»·æ ¼è®¡ç®—
                const basePrice = engine.getBasePrice?.('byd', 'qin-plus', 'th');
                const hasPrice = typeof basePrice === 'number' && basePrice > 0;
                results.push({ name: 'åŸºç¡€ä»·æ ¼è·å–', status: hasPrice ? 'pass' : 'fail', detail: hasPrice ? `à¸¿${basePrice.toLocaleString()}` : 'æ— ä»·æ ¼' });
                
                log('MarketSearchEngine æµ‹è¯•å®Œæˆ', 'success');
            } catch (e) {
                log(`MarketSearchEngine é”™è¯¯: ${e.message}`, 'error');
                results.push({ name: 'æ•´ä½“æµ‹è¯•', status: 'fail', detail: e.message });
            }
            
            testResults.searchengine = results;
            return results;
        }

        // æ¸²æŸ“æµ‹è¯•ç»“æœ
        function renderResults() {
            const render = (id, results) => {
                const el = document.getElementById(id);
                el.innerHTML = results.map(r => createTestItem(r.name, r.status, r.detail)).join('');
            };
            
            render('valuation-tests', testResults.valuation);
            render('predictor-tests', testResults.predictor);
            render('datamanager-tests', testResults.datamanager);
            render('searchengine-tests', testResults.searchengine);
            
            // è®¡ç®—æ€»åˆ†
            const allTests = [...testResults.valuation, ...testResults.predictor, ...testResults.datamanager, ...testResults.searchengine];
            const passed = allTests.filter(t => t.status === 'pass').length;
            const total = allTests.length;
            const score = total > 0 ? Math.round((passed / total) * 100) : 0;
            
            document.getElementById('total-score').textContent = score;
            document.getElementById('total-score').style.color = score >= 90 ? '#0d9488' : score >= 70 ? '#f59e0b' : '#ef4444';
        }

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        window.runAllTests = async function() {
            consoleEl.innerHTML = '';
            log('å¼€å§‹è¿è¡Œæ‰€æœ‰AIåŠŸèƒ½æµ‹è¯•...', 'info');
            
            await testValuationEngine();
            await testMarketPredictor();
            await testDataManager();
            await testSearchEngine();
            
            renderResults();
            log('æ‰€æœ‰æµ‹è¯•å®Œæˆï¼', 'success');
        };

        // åˆå§‹åŒ–
        log('æµ‹è¯•é¢æ¿å·²åŠ è½½ï¼Œç‚¹å‡»"è¿è¡Œæ‰€æœ‰æµ‹è¯•"å¼€å§‹', 'info');
    </script>
</body>
</html>
